<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POS & Gudang Pro</title>
    <link rel="icon" href="data:,">
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --ink: #0f1117;
            --ink2: #3d4350;
            --ink3: #8891a5;
            --border: #e4e7ef;
            --bg: #f0f2f8;
            --surface: #ffffff;
            --accent: #3b5bdb;
            --accent2: #4c6ef5;
            --green: #0ca678;
            --red: #f03e3e;
            --amber: #f59f00;
            --surface2: #f8f9fc;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'DM Sans', sans-serif;
            background: var(--bg);
            color: var(--ink);
            height: 100vh;
            overflow: hidden;
        }

        /* =========== ROLE SCREEN =========== */
        #role-screen {
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #0f1117 0%, #1a2035 50%, #0f1117 100%);
            gap: 0;
        }

        .role-logo {
            font-family: 'DM Mono', monospace;
            font-size: 11px;
            letter-spacing: 4px;
            color: var(--accent2);
            text-transform: uppercase;
            margin-bottom: 16px;
        }

        .role-title {
            font-size: 42px;
            font-weight: 700;
            color: #fff;
            margin-bottom: 8px;
            letter-spacing: -1.5px;
        }

        .role-subtitle {
            color: #8891a5;
            font-size: 15px;
            margin-bottom: 48px;
        }

        .role-cards {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
            justify-content: center;
            padding: 0 20px;
        }

        .role-card {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 16px;
            padding: 32px 36px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            min-width: 200px;
            color: #fff;
        }

        .role-card:hover {
            background: rgba(255,255,255,0.1);
            border-color: rgba(255,255,255,0.25);
            transform: translateY(-3px);
        }

        .role-card .icon { font-size: 40px; margin-bottom: 14px; }
        .role-card .label { font-size: 18px; font-weight: 600; }
        .role-card .desc { font-size: 13px; color: #8891a5; margin-top: 5px; }

        .conn-chip {
            margin-top: 40px;
            font-size: 12px;
            padding: 6px 14px;
            border-radius: 20px;
            background: rgba(255,255,255,0.08);
            color: #aab;
            font-family: 'DM Mono', monospace;
        }

        /* =========== MAIN LAYOUT =========== */
        .app-layout {
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* =========== LEFT PANEL (Products) =========== */
        .panel-left {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: var(--bg);
        }

        .panel-topbar {
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            padding: 14px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            flex-shrink: 0;
        }

        .topbar-title {
            font-weight: 700;
            font-size: 16px;
            color: var(--ink);
            margin-right: auto;
        }

        .topbar-tag {
            font-size: 11px;
            font-family: 'DM Mono', monospace;
            letter-spacing: 1px;
            padding: 4px 10px;
            border-radius: 6px;
            font-weight: 500;
        }

        .tag-kasir { background: #dbe4ff; color: var(--accent); }
        .tag-gudang { background: #fff3bf; color: #b07d00; }

        .exit-btn {
            border: 1px solid var(--border);
            background: var(--surface);
            color: var(--ink2);
            padding: 7px 14px;
            border-radius: 8px;
            font-size: 13px;
            font-family: 'DM Sans', sans-serif;
            cursor: pointer;
            transition: all 0.15s;
        }

        .exit-btn:hover { background: var(--bg); }

        /* Search & Barcode Bar */
        .search-bar {
            padding: 14px 20px;
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            display: flex;
            gap: 10px;
            flex-shrink: 0;
        }

        .search-wrap {
            position: relative;
            flex: 1;
        }

        .search-wrap .icon-search {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--ink3);
            font-size: 16px;
            pointer-events: none;
        }

        .search-input {
            width: 100%;
            padding: 10px 12px 10px 38px;
            border: 1.5px solid var(--border);
            border-radius: 10px;
            font-size: 14px;
            font-family: 'DM Sans', sans-serif;
            color: var(--ink);
            background: var(--bg);
            transition: border-color 0.15s;
            outline: none;
        }

        .search-input:focus {
            border-color: var(--accent2);
            background: #fff;
        }

        .barcode-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 10px;
            font-family: 'DM Sans', sans-serif;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
            transition: background 0.15s;
        }

        .barcode-btn:hover { background: var(--accent2); }
        .barcode-btn svg { width: 18px; height: 18px; }

        /* Product Grid Scrollable */
        .product-scroll {
            flex: 1;
            overflow-y: auto;
            padding: 16px 20px;
        }

        .product-scroll::-webkit-scrollbar { width: 6px; }
        .product-scroll::-webkit-scrollbar-track { background: transparent; }
        .product-scroll::-webkit-scrollbar-thumb { background: #d0d5e8; border-radius: 3px; }

        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 12px;
        }

        .product-card {
            background: var(--surface);
            border: 1.5px solid var(--border);
            border-radius: 12px;
            padding: 14px;
            cursor: pointer;
            transition: all 0.15s;
            position: relative;
            overflow: hidden;
        }

        .product-card::before {
            content: '';
            display: block;
            height: 4px;
            background: var(--accent);
            margin: -14px -14px 12px;
            opacity: 0;
            transition: opacity 0.15s;
        }

        .product-card:hover::before { opacity: 1; }
        .product-card:hover {
            border-color: var(--accent2);
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(59,91,219,0.12);
        }

        .product-card.out-of-stock {
            opacity: 0.45;
            pointer-events: none;
            cursor: not-allowed;
        }

        .product-card .pname {
            font-weight: 600;
            font-size: 13px;
            color: var(--ink);
            margin-bottom: 6px;
            line-height: 1.3;
        }

        .product-card .pprice {
            font-family: 'DM Mono', monospace;
            font-size: 12px;
            color: var(--accent);
            font-weight: 500;
        }

        .stock-badge {
            display: inline-block;
            margin-top: 8px;
            font-size: 11px;
            font-family: 'DM Mono', monospace;
            padding: 3px 8px;
            border-radius: 5px;
            background: #e6fcf5;
            color: var(--green);
        }

        .stock-badge.low { background: #fff3bf; color: var(--amber); }
        .stock-badge.empty { background: #ffe3e3; color: var(--red); }

        /* =========== RIGHT PANEL (Cart) =========== */
        .panel-right {
            width: 320px;
            background: var(--surface);
            border-left: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            flex-shrink: 0;
        }

        .cart-header {
            padding: 18px 20px 14px;
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
        }

        .cart-header h3 {
            font-size: 15px;
            font-weight: 700;
            color: var(--ink);
        }

        .cart-header small {
            color: var(--ink3);
            font-size: 12px;
        }

        .cart-scroll {
            flex: 1;
            overflow-y: auto;
            padding: 10px 16px;
        }

        .cart-scroll::-webkit-scrollbar { width: 4px; }
        .cart-scroll::-webkit-scrollbar-thumb { background: #e0e4f0; border-radius: 2px; }

        .cart-empty {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--ink3);
            font-size: 13px;
            gap: 10px;
        }

        .cart-empty .empty-icon { font-size: 40px; }

        .cart-row {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 10px 0;
            border-bottom: 1px solid var(--border);
        }

        .cart-row:last-child { border-bottom: none; }

        .cart-row .info { flex: 1; }
        .cart-row .info .cname { font-size: 13px; font-weight: 600; color: var(--ink); }
        .cart-row .info .cqty { font-size: 12px; color: var(--ink3); margin-top: 2px; }

        .cart-row .cright {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 4px;
        }

        .cart-row .cprice {
            font-family: 'DM Mono', monospace;
            font-size: 12px;
            font-weight: 500;
            color: var(--ink);
        }

        .qty-ctrl {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .qty-btn {
            width: 24px;
            height: 24px;
            border-radius: 6px;
            border: 1.5px solid var(--border);
            background: var(--bg);
            color: var(--ink);
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
            transition: all 0.1s;
        }

        .qty-btn:hover { background: var(--accent); color: white; border-color: var(--accent); }
        .qty-btn.minus:hover { background: var(--red); border-color: var(--red); }

        .qty-num {
            font-family: 'DM Mono', monospace;
            font-size: 13px;
            font-weight: 500;
            min-width: 20px;
            text-align: center;
        }

        /* Cart Footer */
        .cart-footer {
            border-top: 1px solid var(--border);
            padding: 16px 20px;
            flex-shrink: 0;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
            color: var(--ink3);
            margin-bottom: 6px;
        }

        .summary-total {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 10px 0 14px;
        }

        .summary-total .label {
            font-size: 14px;
            font-weight: 600;
            color: var(--ink);
        }

        .summary-total .amount {
            font-family: 'DM Mono', monospace;
            font-size: 18px;
            font-weight: 700;
            color: var(--ink);
        }

        .pay-btn {
            width: 100%;
            padding: 14px;
            background: var(--green);
            color: white;
            border: none;
            border-radius: 12px;
            font-family: 'DM Sans', sans-serif;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.15s;
            letter-spacing: 0.3px;
        }

        .pay-btn:hover { background: #099268; transform: translateY(-1px); }
        .pay-btn:active { transform: translateY(0); }

        /* =========== GUDANG LAYOUT =========== */
        .gudang-layout {
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        .gudang-left {
            width: 340px;
            background: var(--surface);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            flex-shrink: 0;
        }

        .gudang-right {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: var(--bg);
        }

        .section-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
        }

        .section-header h4 {
            font-size: 14px;
            font-weight: 700;
            color: var(--ink);
        }

        .section-header small {
            color: var(--ink3);
            font-size: 12px;
        }

        .form-scroll {
            flex: 1;
            overflow-y: auto;
            padding: 16px 20px;
        }

        .form-group {
            margin-bottom: 14px;
        }

        .form-group label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            color: var(--ink2);
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-group input {
            width: 100%;
            padding: 10px 12px;
            border: 1.5px solid var(--border);
            border-radius: 8px;
            font-family: 'DM Sans', sans-serif;
            font-size: 14px;
            color: var(--ink);
            background: var(--bg);
            transition: border-color 0.15s;
            outline: none;
        }

        .form-group input:focus {
            border-color: var(--amber);
            background: #fff;
        }

        .add-product-btn {
            width: 100%;
            padding: 12px;
            background: var(--amber);
            color: var(--ink);
            border: none;
            border-radius: 10px;
            font-family: 'DM Sans', sans-serif;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.15s;
            margin-top: 4px;
        }

        .add-product-btn:hover { background: #e67700; color: #fff; }

        /* Stock Table */
        .stock-scroll {
            flex: 1;
            overflow-y: auto;
            padding: 16px 20px;
        }

        .stock-scroll::-webkit-scrollbar { width: 6px; }
        .stock-scroll::-webkit-scrollbar-thumb { background: #d0d5e8; border-radius: 3px; }

        .stock-table {
            width: 100%;
            border-collapse: collapse;
        }

        .stock-table thead th {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            color: var(--ink3);
            font-weight: 600;
            padding: 8px 10px;
            border-bottom: 2px solid var(--border);
            text-align: left;
        }

        .stock-table tbody tr {
            border-bottom: 1px solid var(--border);
            transition: background 0.1s;
        }

        .stock-table tbody tr:hover { background: var(--surface2); }

        .stock-table td {
            padding: 10px 10px;
            font-size: 13px;
            vertical-align: middle;
        }

        .td-name { font-weight: 600; color: var(--ink); }
        .td-price {
            font-family: 'DM Mono', monospace;
            font-size: 12px;
            color: var(--ink2);
        }

        .td-stock-ctrl {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .stock-num {
            font-family: 'DM Mono', monospace;
            font-size: 13px;
            font-weight: 700;
            min-width: 28px;
            text-align: center;
        }

        .sctrl-btn {
            width: 26px;
            height: 26px;
            border-radius: 6px;
            border: 1.5px solid var(--border);
            background: var(--surface);
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.1s;
        }

        .sctrl-btn.plus:hover { background: var(--green); color: #fff; border-color: var(--green); }
        .sctrl-btn.minus:hover { background: var(--red); color: #fff; border-color: var(--red); }

        .del-btn {
            width: 26px;
            height: 26px;
            border-radius: 6px;
            border: 1.5px solid #ffd0d0;
            background: #fff5f5;
            color: var(--red);
            font-size: 13px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.1s;
        }
        .del-btn:hover { background: var(--red); color: #fff; border-color: var(--red); }

        /* =========== BARCODE SCANNER MODAL =========== */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(10,12,20,0.7);
            backdrop-filter: blur(4px);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-box {
            background: var(--surface);
            border-radius: 16px;
            width: 90%;
            max-width: 440px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .modal-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-header h4 { font-size: 15px; font-weight: 700; }

        .modal-close {
            width: 30px;
            height: 30px;
            border-radius: 8px;
            border: 1.5px solid var(--border);
            background: var(--bg);
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--ink2);
        }

        #scanner-container {
            position: relative;
            width: 100%;
            aspect-ratio: 4/3;
            background: #000;
            overflow: hidden;
        }

        #scanner-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .scanner-line {
            position: absolute;
            left: 10%;
            right: 10%;
            height: 2px;
            background: #4c6ef5;
            box-shadow: 0 0 12px #4c6ef5;
            animation: scan 2s ease-in-out infinite;
        }

        @keyframes scan {
            0%, 100% { top: 20%; }
            50% { top: 80%; }
        }

        .scanner-frame {
            position: absolute;
            inset: 10%;
            border: 2px solid rgba(255,255,255,0.5);
            border-radius: 8px;
        }

        .scanner-corner {
            position: absolute;
            width: 20px;
            height: 20px;
            border-color: #4c6ef5;
            border-style: solid;
        }
        .scanner-corner.tl { top: 10%; left: 10%; border-width: 3px 0 0 3px; border-radius: 4px 0 0 0; }
        .scanner-corner.tr { top: 10%; right: 10%; border-width: 3px 3px 0 0; border-radius: 0 4px 0 0; }
        .scanner-corner.bl { bottom: 10%; left: 10%; border-width: 0 0 3px 3px; border-radius: 0 0 0 4px; }
        .scanner-corner.br { bottom: 10%; right: 10%; border-width: 0 3px 3px 0; border-radius: 0 0 4px 0; }

        .scanner-result {
            padding: 14px 20px;
            font-family: 'DM Mono', monospace;
            font-size: 13px;
            color: var(--ink2);
            border-top: 1px solid var(--border);
            min-height: 48px;
        }

        .scanner-result.found { color: var(--green); font-weight: 600; }
        .scanner-result.notfound { color: var(--red); }

        .hidden { display: none !important; }

        /* Notif toast */
        .toast {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%) translateY(80px);
            background: #0f1117;
            color: #fff;
            padding: 12px 20px;
            border-radius: 10px;
            font-size: 13px;
            font-weight: 500;
            z-index: 9999;
            transition: transform 0.3s ease;
            white-space: nowrap;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .toast.show { transform: translateX(-50%) translateY(0); }
        .toast.success { background: var(--green); }
        .toast.error { background: var(--red); }

        @media (max-width: 600px) {
            .panel-right { width: 100%; }
            .app-layout { flex-direction: column; }
            .gudang-layout { flex-direction: column; }
            .gudang-left { width: 100%; max-height: 50vh; }
        }
    </style>
</head>
<body>

<!-- ROLE SCREEN -->
<div id="role-screen">
    <p class="role-logo">POS SYSTEM</p>
    <h1 class="role-title">Pilih Mode</h1>
    <p class="role-subtitle">Masuk sebagai Kasir atau petugas Gudang</p>
    <div class="role-cards">
        <div class="role-card" id="btn-kasir">
            <div class="icon">üì≤</div>
            <div class="label">KASIR</div>
            <div class="desc">Transaksi & Pembayaran</div>
        </div>
        <div class="role-card" id="btn-gudang">
            <div class="icon">üì¶</div>
            <div class="label">GUDANG</div>
            <div class="desc">Kelola Produk & Stok</div>
        </div>
    </div>
    <div class="conn-chip" id="conn-status">‚è≥ Menghubungkan ke database...</div>
</div>

<!-- KASIR SCREEN -->
<div id="kasir-screen" class="hidden">
    <div class="app-layout">
        <!-- Kiri: Produk -->
        <div class="panel-left">
            <div class="panel-topbar">
                <span class="topbar-title">POS Pro</span>
                <span class="topbar-tag tag-kasir">KASIR</span>
                <button class="exit-btn" onclick="resetRole()">Keluar</button>
            </div>
            <div class="search-bar">
                <div class="search-wrap">
                    <span class="icon-search">üîç</span>
                    <input type="text" class="search-input" id="search-kasir" placeholder="Cari produk..." oninput="filterProducts()">
                </div>
                <button class="barcode-btn" onclick="openScanner('kasir')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 7V5a2 2 0 012-2h2M17 3h2a2 2 0 012 2v2M21 17v2a2 2 0 01-2 2h-2M7 21H5a2 2 0 01-2-2v-2"/>
                        <line x1="7" y1="8" x2="7" y2="16"/><line x1="10" y1="8" x2="10" y2="16"/>
                        <line x1="13" y1="8" x2="13" y2="16"/><line x1="16" y1="8" x2="16" y2="16"/>
                    </svg>
                    Scan
                </button>
            </div>
            <div class="product-scroll">
                <div class="product-grid" id="product-list-kasir"></div>
            </div>
        </div>

        <!-- Kanan: Keranjang -->
        <div class="panel-right">
            <div class="cart-header">
                <h3>Keranjang</h3>
                <small id="cart-count">0 item</small>
            </div>
            <div class="cart-scroll" id="cart-list">
                <div class="cart-empty">
                    <div class="empty-icon">üõí</div>
                    <span>Pilih produk untuk mulai</span>
                </div>
            </div>
            <div class="cart-footer">
                <div class="summary-row"><span>Subtotal</span><span id="subtotal-price">Rp 0</span></div>
                <div class="summary-total">
                    <span class="label">TOTAL</span>
                    <span class="amount" id="total-price">Rp 0</span>
                </div>
                <button class="pay-btn" onclick="processPayment()">BAYAR SEKARANG ‚Üí</button>
            </div>
        </div>
    </div>
</div>

<!-- GUDANG SCREEN -->
<div id="gudang-screen" class="hidden">
    <div class="gudang-layout">
        <!-- Kiri: Form -->
        <div class="gudang-left">
            <div class="panel-topbar">
                <span class="topbar-title">Gudang Pro</span>
                <span class="topbar-tag tag-gudang">GUDANG</span>
                <button class="exit-btn" onclick="resetRole()">Keluar</button>
            </div>
            <div class="form-scroll">
                <div class="section-header" style="padding:0; border:none; margin-bottom:16px;">
                    <h4>Tambah Produk Baru</h4>
                    <small>Isi form untuk menambah ke database</small>
                </div>
                <div class="form-group">
                    <label>Nama Produk</label>
                    <input type="text" id="new-name" placeholder="Contoh: Kopi Arabika 250g">
                </div>
                <div class="form-group">
                    <label>Harga Jual (Rp)</label>
                    <input type="number" id="new-price" placeholder="15000">
                </div>
                <div class="form-group">
                    <label>Stok Awal</label>
                    <input type="number" id="new-stock" placeholder="50">
                </div>
                <div class="form-group">
                    <label>Barcode (Opsional)</label>
                    <div style="display:flex; gap:8px;">
                        <input type="text" id="new-barcode" placeholder="Scan atau ketik kode" style="flex:1;">
                        <button onclick="openScanner('gudang-input')" style="padding:10px 12px; background:var(--accent); color:#fff; border:none; border-radius:8px; cursor:pointer; font-size:16px;" title="Scan Barcode">üì∑</button>
                    </div>
                </div>
                <button class="add-product-btn" onclick="addProduct()">+ Tambah ke Database</button>
            </div>
        </div>

        <!-- Kanan: Daftar Stok -->
        <div class="gudang-right">
            <div class="panel-topbar">
                <span class="topbar-title">Daftar Stok</span>
                <div class="search-wrap" style="width:220px;">
                    <span class="icon-search">üîç</span>
                    <input type="text" class="search-input" id="search-gudang" placeholder="Cari produk..." oninput="renderStockGudang()">
                </div>
                <button class="barcode-btn" onclick="openScanner('gudang-cek')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px">
                        <path d="M3 7V5a2 2 0 012-2h2M17 3h2a2 2 0 012 2v2M21 17v2a2 2 0 01-2 2h-2M7 21H5a2 2 0 01-2-2v-2"/>
                        <line x1="7" y1="8" x2="7" y2="16"/><line x1="10" y1="8" x2="10" y2="16"/>
                        <line x1="13" y1="8" x2="13" y2="16"/><line x1="16" y1="8" x2="16" y2="16"/>
                    </svg>
                    Cek Stok
                </button>
            </div>
            <div class="stock-scroll">
                <table class="stock-table">
                    <thead>
                        <tr>
                            <th>Produk</th>
                            <th>Harga</th>
                            <th>Barcode</th>
                            <th>Stok</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="stock-list"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- SCANNER MODAL -->
<div id="scanner-modal" class="modal-overlay hidden">
    <div class="modal-box">
        <div class="modal-header">
            <h4>üì∑ Scan Barcode</h4>
            <button class="modal-close" onclick="closeScanner()">‚úï</button>
        </div>
        <div id="scanner-container">
            <video id="scanner-video" autoplay playsinline muted></video>
            <div class="scanner-line"></div>
            <div class="scanner-corner tl"></div>
            <div class="scanner-corner tr"></div>
            <div class="scanner-corner bl"></div>
            <div class="scanner-corner br"></div>
        </div>
        <div class="scanner-result" id="scanner-result">Arahkan kamera ke barcode produk...</div>
    </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<!-- ZXing Barcode Library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/zxing-js/0.19.1/zxing.min.js"></script>

<!-- Konfigurasi Firebase (file terpisah) -->
<script src="config.js"></script>

<script>
// ========== FIREBASE ==========

try {
    firebase.initializeApp(firebaseConfig);
    var db = firebase.database();
    var productsRef = db.ref('products');
    document.getElementById('conn-status').innerHTML = "‚úÖ Database Terhubung";
    document.getElementById('btn-kasir').onclick = function() { setRole('kasir'); };
    document.getElementById('btn-gudang').onclick = function() { setRole('gudang'); };
} catch (e) {
    document.getElementById('conn-status').innerHTML = "‚ùå Gagal: " + e.message;
}

// ========== STATE ==========
var productsData = {};
var cart = [];
var scannerMode = '';
var codeReader = null;
var scannerStream = null;

// ========== TOAST ==========
function showToast(msg, type) {
    var t = document.getElementById('toast');
    t.textContent = msg;
    t.className = 'toast ' + (type || '');
    t.classList.add('show');
    setTimeout(function() { t.classList.remove('show'); }, 2500);
}

// ========== NAVIGATION ==========
function setRole(role) {
    localStorage.setItem('appRole', role);
    document.getElementById('role-screen').classList.add('hidden');
    if (role === 'kasir') {
        document.getElementById('kasir-screen').classList.remove('hidden');
        renderProductKasir();
    } else {
        document.getElementById('gudang-screen').classList.remove('hidden');
        renderStockGudang();
    }
}

function resetRole() {
    localStorage.removeItem('appRole');
    location.reload();
}

var currentRole = localStorage.getItem('appRole');
if (currentRole) setRole(currentRole);

// ========== KASIR ==========
function filterProducts() {
    renderProductKasir();
}

function renderProductKasir() {
    var q = (document.getElementById('search-kasir').value || '').toLowerCase();
    var container = document.getElementById('product-list-kasir');
    container.innerHTML = '';
    var keys = Object.keys(productsData);
    var filtered = keys.filter(function(id) {
        var p = productsData[id];
        return p.name.toLowerCase().includes(q) || (p.barcode && p.barcode.toLowerCase().includes(q));
    });

    if (filtered.length === 0) {
        container.innerHTML = '<p style="color:var(--ink3); font-size:13px; grid-column:1/-1; padding:20px 0;">Produk tidak ditemukan</p>';
        return;
    }

    filtered.forEach(function(id) {
        var p = productsData[id];
        var stockClass = p.stock <= 0 ? 'empty' : p.stock <= 5 ? 'low' : '';
        var stockLabel = p.stock <= 0 ? 'Habis' : 'Stok: ' + p.stock;
        var div = document.createElement('div');
        div.className = 'product-card' + (p.stock <= 0 ? ' out-of-stock' : '');
        div.onclick = function() { addToCart(id); };
        div.innerHTML = '<div class="pname">' + p.name + '</div>' +
            '<div class="pprice">Rp ' + p.price.toLocaleString('id-ID') + '</div>' +
            '<div class="stock-badge ' + stockClass + '">' + stockLabel + '</div>';
        container.appendChild(div);
    });
}

function addToCart(id) {
    var p = productsData[id];
    if (!p || p.stock <= 0) return;
    var found = false;
    for (var i = 0; i < cart.length; i++) {
        if (cart[i].id === id) {
            if (cart[i].qty < p.stock) { cart[i].qty++; }
            else { showToast('Stok tidak mencukupi!', 'error'); }
            found = true;
            break;
        }
    }
    if (!found) cart.push({ id: id, name: p.name, price: p.price, qty: 1 });
    renderCart();
}

function changeQty(index, delta) {
    cart[index].qty += delta;
    if (cart[index].qty <= 0) cart.splice(index, 1);
    renderCart();
}

function renderCart() {
    var container = document.getElementById('cart-list');
    container.innerHTML = '';
    var total = 0;

    if (cart.length === 0) {
        container.innerHTML = '<div class="cart-empty"><div class="empty-icon">üõí</div><span>Pilih produk untuk mulai</span></div>';
        document.getElementById('cart-count').textContent = '0 item';
        document.getElementById('total-price').textContent = 'Rp 0';
        document.getElementById('subtotal-price').textContent = 'Rp 0';
        return;
    }

    var totalItems = 0;
    cart.forEach(function(item, i) {
        var subtotal = item.price * item.qty;
        total += subtotal;
        totalItems += item.qty;
        var row = document.createElement('div');
        row.className = 'cart-row';
        row.innerHTML = '<div class="info"><div class="cname">' + item.name + '</div>' +
            '<div class="cqty">@Rp ' + item.price.toLocaleString('id-ID') + '</div></div>' +
            '<div class="cright">' +
            '<div class="cprice">Rp ' + subtotal.toLocaleString('id-ID') + '</div>' +
            '<div class="qty-ctrl">' +
            '<button class="qty-btn minus" onclick="changeQty(' + i + ', -1)">‚àí</button>' +
            '<span class="qty-num">' + item.qty + '</span>' +
            '<button class="qty-btn" onclick="changeQty(' + i + ', 1)">+</button>' +
            '</div></div>';
        container.appendChild(row);
    });

    document.getElementById('cart-count').textContent = totalItems + ' item';
    document.getElementById('total-price').textContent = 'Rp ' + total.toLocaleString('id-ID');
    document.getElementById('subtotal-price').textContent = 'Rp ' + total.toLocaleString('id-ID');
}

function processPayment() {
    if (cart.length === 0) return showToast('Keranjang kosong!', 'error');
    var updates = {};
    for (var i = 0; i < cart.length; i++) {
        var item = cart[i];
        var current = productsData[item.id] ? productsData[item.id].stock : 0;
        if (current < item.qty) { showToast('Stok ' + item.name + ' tidak cukup!', 'error'); return; }
        updates['/products/' + item.id + '/stock'] = current - item.qty;
    }
    db.ref().update(updates).then(function() {
        showToast('‚úÖ Pembayaran berhasil!', 'success');
        cart = [];
        renderCart();
    }).catch(function(e) {
        showToast('Gagal: ' + e.message, 'error');
    });
}

// ========== GUDANG ==========
function addProduct() {
    var name = document.getElementById('new-name').value.trim();
    var price = parseInt(document.getElementById('new-price').value);
    var stock = parseInt(document.getElementById('new-stock').value);
    var barcode = document.getElementById('new-barcode').value.trim();
    if (!name || isNaN(price) || isNaN(stock)) { showToast('Lengkapi semua data!', 'error'); return; }
    var data = { name: name, price: price, stock: stock };
    if (barcode) data.barcode = barcode;
    productsRef.push(data).then(function() {
        showToast('‚úÖ Produk berhasil ditambahkan!', 'success');
        document.getElementById('new-name').value = '';
        document.getElementById('new-price').value = '';
        document.getElementById('new-stock').value = '';
        document.getElementById('new-barcode').value = '';
    }).catch(function(e) { showToast('Gagal: ' + e.message, 'error'); });
}

function updateStock(id, newStock) {
    if (newStock < 0) newStock = 0;
    var updates = {};
    updates['/products/' + id + '/stock'] = newStock;
    db.ref().update(updates);
}

function deleteProduct(id) {
    if (!confirm('Hapus produk ini?')) return;
    productsRef.child(id).remove().then(function() {
        showToast('Produk dihapus', '');
    });
}

function renderStockGudang() {
    var q = (document.getElementById('search-gudang').value || '').toLowerCase();
    var tbody = document.getElementById('stock-list');
    tbody.innerHTML = '';
    var keys = Object.keys(productsData);
    var filtered = keys.filter(function(id) {
        var p = productsData[id];
        return p.name.toLowerCase().includes(q) || (p.barcode && p.barcode.toLowerCase().includes(q));
    });

    if (filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; color:var(--ink3); padding:30px; font-size:13px;">Produk tidak ditemukan</td></tr>';
        return;
    }

    filtered.forEach(function(id) {
        var p = productsData[id];
        var tr = document.createElement('tr');
        tr.innerHTML = '<td class="td-name">' + p.name + '</td>' +
            '<td class="td-price">Rp ' + p.price.toLocaleString('id-ID') + '</td>' +
            '<td style="font-family:DM Mono,monospace; font-size:11px; color:var(--ink3);">' + (p.barcode || '‚Äî') + '</td>' +
            '<td><div class="td-stock-ctrl">' +
            '<button class="sctrl-btn minus" onclick="updateStock(\'' + id + '\', ' + (p.stock - 1) + ')">‚àí</button>' +
            '<span class="stock-num">' + p.stock + '</span>' +
            '<button class="sctrl-btn plus" onclick="updateStock(\'' + id + '\', ' + (p.stock + 1) + ')">+</button>' +
            '</div></td>' +
            '<td><button class="del-btn" onclick="deleteProduct(\'' + id + '\')">üóë</button></td>';
        tbody.appendChild(tr);
    });
}

// ========== BARCODE SCANNER ==========
function openScanner(mode) {
    scannerMode = mode;
    document.getElementById('scanner-modal').classList.remove('hidden');
    document.getElementById('scanner-result').textContent = 'Arahkan kamera ke barcode produk...';
    document.getElementById('scanner-result').className = 'scanner-result';
    startCamera();
}

function closeScanner() {
    document.getElementById('scanner-modal').classList.add('hidden');
    stopCamera();
}

function startCamera() {
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        document.getElementById('scanner-result').textContent = '‚ùå Kamera tidak didukung di browser ini';
        return;
    }
    navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
        .then(function(stream) {
            scannerStream = stream;
            var video = document.getElementById('scanner-video');
            video.srcObject = stream;
            video.play();
            startBarcodeDetection(video);
        })
        .catch(function(e) {
            document.getElementById('scanner-result').textContent = '‚ùå Gagal akses kamera: ' + e.message;
        });
}

function stopCamera() {
    if (scannerStream) {
        scannerStream.getTracks().forEach(function(t) { t.stop(); });
        scannerStream = null;
    }
    if (codeReader) {
        try { codeReader.reset(); } catch(e) {}
        codeReader = null;
    }
}

function startBarcodeDetection(video) {
    // Gunakan BarcodeDetector bawaan browser (Chrome/Edge) jika tersedia
    if ('BarcodeDetector' in window) {
        var detector = new BarcodeDetector({ formats: ['ean_13', 'ean_8', 'qr_code', 'code_128', 'code_39', 'upc_a', 'upc_e'] });
        var scanning = true;

        function detect() {
            if (!scanning || !scannerStream) return;
            detector.detect(video).then(function(barcodes) {
                if (barcodes.length > 0) {
                    scanning = false;
                    handleBarcode(barcodes[0].rawValue);
                } else {
                    requestAnimationFrame(detect);
                }
            }).catch(function() {
                requestAnimationFrame(detect);
            });
        }

        video.onloadedmetadata = function() { detect(); };
        // Pastikan detect berjalan jika video sudah siap
        if (video.readyState >= 2) detect();

    } else if (typeof ZXing !== 'undefined') {
        // Fallback ke ZXing
        try {
            codeReader = new ZXing.BrowserMultiFormatReader();
            codeReader.decodeFromVideoElement(video, function(result, err) {
                if (result) {
                    codeReader.reset();
                    handleBarcode(result.getText());
                }
            });
        } catch(e) {
            document.getElementById('scanner-result').textContent = '‚ö† Scanner tidak tersedia. Ketik barcode manual.';
        }
    } else {
        document.getElementById('scanner-result').textContent = '‚ö† Browser tidak mendukung scan otomatis. Gunakan Chrome/Edge terbaru.';
    }
}

function handleBarcode(code) {
    document.getElementById('scanner-result').textContent = '‚úÖ Terdeteksi: ' + code;
    document.getElementById('scanner-result').className = 'scanner-result found';

    if (scannerMode === 'gudang-input') {
        document.getElementById('new-barcode').value = code;
        closeScanner();
        showToast('Barcode: ' + code, 'success');
    } else if (scannerMode === 'gudang-cek') {
        var found = null;
        for (var id in productsData) {
            if (productsData[id].barcode === code) { found = productsData[id]; break; }
        }
        if (found) {
            document.getElementById('scanner-result').textContent = '‚úÖ ' + found.name + ' ‚Äî Stok: ' + found.stock;
            document.getElementById('search-gudang').value = found.name;
            renderStockGudang();
        } else {
            document.getElementById('scanner-result').textContent = '‚ö† Barcode tidak ditemukan di database';
            document.getElementById('scanner-result').className = 'scanner-result notfound';
        }
        setTimeout(closeScanner, 2000);
    } else if (scannerMode === 'kasir') {
        var foundId = null;
        for (var pid in productsData) {
            if (productsData[pid].barcode === code) { foundId = pid; break; }
        }
        if (foundId) {
            addToCart(foundId);
            document.getElementById('scanner-result').textContent = '‚úÖ ' + productsData[foundId].name + ' ditambahkan!';
            setTimeout(closeScanner, 1000);
        } else {
            document.getElementById('search-kasir').value = code;
            filterProducts();
            document.getElementById('scanner-result').textContent = 'üîç Mencari: ' + code;
            setTimeout(closeScanner, 1000);
        }
    }
}

// ========== REALTIME LISTENER ==========
productsRef.on('value', function(snapshot) {
    productsData = snapshot.val() || {};
    var role = localStorage.getItem('appRole');
    if (role === 'kasir') renderProductKasir();
    if (role === 'gudang') renderStockGudang();
});
</script>
</body>
</html>