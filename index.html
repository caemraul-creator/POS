<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POS & Gudang Pro</title>
    <link rel="icon" href="data:,">
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>
    
    <style>
        /* CSS LENGKAP - Tidak dipotong */
        :root {
            --ink: #0f1117; --ink2: #3d4350; --ink3: #8891a5; --border: #e4e7ef;
            --bg: #f0f2f8; --surface: #ffffff; --accent: #3b5bdb; --accent2: #4c6ef5;
            --green: #0ca678; --red: #f03e3e; --amber: #f59f00; --surface2: #f8f9fc;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'DM Sans', sans-serif;
            background: var(--bg);
            color: var(--ink);
            height: 100vh;
            overflow: hidden;
        }

        /* =========== ROLE SCREEN =========== */
        #role-screen {
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #0f1117 0%, #1a2035 50%, #0f1117 100%);
            gap: 0;
        }

        .role-logo {
            font-family: 'DM Mono', monospace;
            font-size: 11px;
            letter-spacing: 4px;
            color: var(--accent2);
            text-transform: uppercase;
            margin-bottom: 16px;
        }

        .role-title {
            font-size: 42px;
            font-weight: 700;
            color: #fff;
            margin-bottom: 8px;
            letter-spacing: -1.5px;
        }

        .role-subtitle {
            color: #8891a5;
            font-size: 15px;
            margin-bottom: 48px;
        }

        .role-cards {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
            justify-content: center;
            padding: 0 20px;
        }

        .role-card {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 16px;
            padding: 32px 36px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            min-width: 200px;
            color: #fff;
        }

        .role-card:hover {
            background: rgba(255,255,255,0.1);
            border-color: rgba(255,255,255,0.25);
            transform: translateY(-3px);
        }

        .role-card .icon { font-size: 40px; margin-bottom: 14px; }
        .role-card .label { font-size: 18px; font-weight: 600; }
        .role-card .desc { font-size: 13px; color: #8891a5; margin-top: 5px; }

        .conn-chip {
            margin-top: 40px;
            font-size: 12px;
            padding: 6px 14px;
            border-radius: 20px;
            background: rgba(255,255,255,0.08);
            color: #aab;
            font-family: 'DM Mono', monospace;
        }

        /* =========== MAIN LAYOUT =========== */
        .app-layout {
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* =========== LEFT PANEL (Products) =========== */
        .panel-left {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: var(--bg);
        }

        .panel-topbar {
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            padding: 14px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            flex-shrink: 0;
        }

        .topbar-title {
            font-weight: 700;
            font-size: 16px;
            color: var(--ink);
            margin-right: auto;
        }

        .topbar-tag {
            font-size: 11px;
            font-family: 'DM Mono', monospace;
            letter-spacing: 1px;
            padding: 4px 10px;
            border-radius: 6px;
            font-weight: 500;
        }

        .tag-kasir { background: #dbe4ff; color: var(--accent); }
        .tag-gudang { background: #fff3bf; color: #b07d00; }

        .exit-btn {
            border: 1px solid var(--border);
            background: var(--surface);
            color: var(--ink2);
            padding: 7px 14px;
            border-radius: 8px;
            font-size: 13px;
            font-family: 'DM Sans', sans-serif;
            cursor: pointer;
            transition: all 0.15s;
        }

        .exit-btn:hover { background: var(--bg); }

        /* Search & Barcode Bar */
        .search-bar {
            padding: 14px 20px;
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            display: flex;
            gap: 10px;
            flex-shrink: 0;
        }

        .search-wrap {
            position: relative;
            flex: 1;
        }

        .search-wrap .icon-search {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--ink3);
            font-size: 16px;
            pointer-events: none;
        }

        .search-input {
            width: 100%;
            padding: 10px 12px 10px 38px;
            border: 1.5px solid var(--border);
            border-radius: 10px;
            font-size: 14px;
            font-family: 'DM Sans', sans-serif;
            color: var(--ink);
            background: var(--bg);
            transition: border-color 0.15s;
            outline: none;
        }

        .search-input:focus {
            border-color: var(--accent2);
            background: #fff;
        }

        .barcode-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 10px;
            font-family: 'DM Sans', sans-serif;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
            transition: background 0.15s;
        }

        .barcode-btn:hover { background: var(--accent2); }
        .barcode-btn svg { width: 18px; height: 18px; }

        /* Product Grid Scrollable */
        .product-scroll {
            flex: 1;
            overflow-y: auto;
            padding: 16px 20px;
        }

        .product-scroll::-webkit-scrollbar { width: 6px; }
        .product-scroll::-webkit-scrollbar-track { background: transparent; }
        .product-scroll::-webkit-scrollbar-thumb { background: #d0d5e8; border-radius: 3px; }

        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 12px;
        }

        .product-card {
            background: var(--surface);
            border: 1.5px solid var(--border);
            border-radius: 12px;
            padding: 14px;
            cursor: pointer;
            transition: all 0.15s;
            position: relative;
            overflow: hidden;
        }

        .product-card::before {
            content: '';
            display: block;
            height: 4px;
            background: var(--accent);
            margin: -14px -14px 12px;
            opacity: 0;
            transition: opacity 0.15s;
        }

        .product-card:hover::before { opacity: 1; }
        .product-card:hover {
            border-color: var(--accent2);
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(59,91,219,0.12);
        }

        .product-card.out-of-stock {
            opacity: 0.45;
            pointer-events: none;
            cursor: not-allowed;
        }

        .product-card .pname {
            font-weight: 600;
            font-size: 13px;
            color: var(--ink);
            margin-bottom: 6px;
            line-height: 1.3;
        }

        .product-card .pprice {
            font-family: 'DM Mono', monospace;
            font-size: 12px;
            color: var(--accent);
            font-weight: 500;
        }

        .stock-badge {
            display: inline-block;
            margin-top: 8px;
            font-size: 11px;
            font-family: 'DM Mono', monospace;
            padding: 3px 8px;
            border-radius: 5px;
            background: #e6fcf5;
            color: var(--green);
        }

        .stock-badge.low { background: #fff3bf; color: var(--amber); }
        .stock-badge.empty { background: #ffe3e3; color: var(--red); }

        /* =========== RIGHT PANEL (Cart) =========== */
        .panel-right {
            width: 320px;
            background: var(--surface);
            border-left: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            flex-shrink: 0;
        }

        .cart-header {
            padding: 18px 20px 14px;
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
        }

        .cart-header h3 {
            font-size: 15px;
            font-weight: 700;
            color: var(--ink);
        }

        .cart-header small {
            color: var(--ink3);
            font-size: 12px;
        }

        .cart-scroll {
            flex: 1;
            overflow-y: auto;
            padding: 10px 16px;
        }

        .cart-scroll::-webkit-scrollbar { width: 4px; }
        .cart-scroll::-webkit-scrollbar-thumb { background: #e0e4f0; border-radius: 2px; }

        .cart-empty {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--ink3);
            font-size: 13px;
            gap: 10px;
        }

        .cart-empty .empty-icon { font-size: 40px; }

        .cart-row {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 10px 0;
            border-bottom: 1px solid var(--border);
        }

        .cart-row:last-child { border-bottom: none; }

        .cart-row .info { flex: 1; }
        .cart-row .info .cname { font-size: 13px; font-weight: 600; color: var(--ink); }
        .cart-row .info .cqty { font-size: 12px; color: var(--ink3); margin-top: 2px; }

        .cart-row .cright {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 4px;
        }

        .cart-row .cprice {
            font-family: 'DM Mono', monospace;
            font-size: 12px;
            font-weight: 500;
            color: var(--ink);
        }

        .qty-ctrl {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .qty-btn {
            width: 24px;
            height: 24px;
            border-radius: 6px;
            border: 1.5px solid var(--border);
            background: var(--bg);
            color: var(--ink);
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
            transition: all 0.1s;
        }

        .qty-btn:hover { background: var(--accent); color: white; border-color: var(--accent); }
        .qty-btn.minus:hover { background: var(--red); border-color: var(--red); }

        .qty-num {
            font-family: 'DM Mono', monospace;
            font-size: 13px;
            font-weight: 500;
            min-width: 20px;
            text-align: center;
        }

        /* Cart Footer */
        .cart-footer {
            border-top: 1px solid var(--border);
            padding: 16px 20px;
            flex-shrink: 0;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
            color: var(--ink3);
            margin-bottom: 6px;
        }

        .summary-total {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 10px 0 14px;
        }

        .summary-total .label {
            font-size: 14px;
            font-weight: 600;
            color: var(--ink);
        }

        .summary-total .amount {
            font-family: 'DM Mono', monospace;
            font-size: 18px;
            font-weight: 700;
            color: var(--ink);
        }

        .pay-btn {
            width: 100%;
            padding: 14px;
            background: var(--green);
            color: white;
            border: none;
            border-radius: 12px;
            font-family: 'DM Sans', sans-serif;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.15s;
            letter-spacing: 0.3px;
        }

        .pay-btn:hover { background: #099268; transform: translateY(-1px); }
        .pay-btn:active { transform: translateY(0); }

        /* =========== GUDANG LAYOUT =========== */
        .gudang-layout {
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        .gudang-left {
            width: 340px;
            background: var(--surface);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            flex-shrink: 0;
        }

        .gudang-right {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: var(--bg);
        }

        .section-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
        }

        .section-header h4 {
            font-size: 14px;
            font-weight: 700;
            color: var(--ink);
        }

        .section-header small {
            color: var(--ink3);
            font-size: 12px;
        }

        .form-scroll {
            flex: 1;
            overflow-y: auto;
            padding: 16px 20px;
        }

        .form-group {
            margin-bottom: 14px;
        }

        .form-group label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            color: var(--ink2);
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-group input {
            width: 100%;
            padding: 10px 12px;
            border: 1.5px solid var(--border);
            border-radius: 8px;
            font-family: 'DM Sans', sans-serif;
            font-size: 14px;
            color: var(--ink);
            background: var(--bg);
            transition: border-color 0.15s;
            outline: none;
        }

        .form-group input:focus {
            border-color: var(--amber);
            background: #fff;
        }

        .add-product-btn {
            width: 100%;
            padding: 12px;
            background: var(--amber);
            color: var(--ink);
            border: none;
            border-radius: 10px;
            font-family: 'DM Sans', sans-serif;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.15s;
            margin-top: 4px;
        }

        .add-product-btn:hover { background: #e67700; color: #fff; }

        /* Stock Table */
        .stock-scroll {
            flex: 1;
            overflow-y: auto;
            padding: 16px 20px;
        }

        .stock-scroll::-webkit-scrollbar { width: 6px; }
        .stock-scroll::-webkit-scrollbar-thumb { background: #d0d5e8; border-radius: 3px; }

        .stock-table {
            width: 100%;
            border-collapse: collapse;
        }

        .stock-table thead th {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            color: var(--ink3);
            font-weight: 600;
            padding: 8px 10px;
            border-bottom: 2px solid var(--border);
            text-align: left;
        }

        .stock-table tbody tr {
            border-bottom: 1px solid var(--border);
            transition: background 0.1s;
        }

        .stock-table tbody tr:hover { background: var(--surface2); }

        .stock-table td {
            padding: 10px 10px;
            font-size: 13px;
            vertical-align: middle;
        }

        .td-name { font-weight: 600; color: var(--ink); }
        .td-price {
            font-family: 'DM Mono', monospace;
            font-size: 12px;
            color: var(--ink2);
        }

        .td-stock-ctrl {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .stock-num {
            font-family: 'DM Mono', monospace;
            font-size: 13px;
            font-weight: 700;
            min-width: 28px;
            text-align: center;
        }

        .sctrl-btn {
            width: 26px;
            height: 26px;
            border-radius: 6px;
            border: 1.5px solid var(--border);
            background: var(--surface);
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.1s;
        }

        .sctrl-btn.plus:hover { background: var(--green); color: #fff; border-color: var(--green); }
        .sctrl-btn.minus:hover { background: var(--red); color: #fff; border-color: var(--red); }

        .del-btn {
            width: 26px;
            height: 26px;
            border-radius: 6px;
            border: 1.5px solid #ffd0d0;
            background: #fff5f5;
            color: var(--red);
            font-size: 13px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.1s;
        }
        .del-btn:hover { background: var(--red); color: #fff; border-color: var(--red); }

        .edit-btn {
            width: 26px;
            height: 26px;
            border-radius: 6px;
            border: 1.5px solid #d0e0ff;
            background: #eef3ff;
            color: var(--accent);
            font-size: 13px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.1s;
        }
        .edit-btn:hover { background: var(--accent); color: #fff; border-color: var(--accent); }

        .action-btns { display: flex; gap: 5px; }

        /* Barcode image in table */
        .barcode-cell {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 4px;
        }

        .barcode-cell svg {
            max-width: 130px;
            height: 40px;
        }

        .barcode-cell .bc-code {
            font-family: 'DM Mono', monospace;
            font-size: 10px;
            color: var(--ink3);
        }

        .barcode-cell .no-barcode {
            font-size: 11px;
            color: var(--ink3);
            font-style: italic;
        }

        .print-bc-btn {
            margin-top: 3px;
            padding: 3px 8px;
            font-size: 11px;
            font-family: 'DM Sans', sans-serif;
            background: var(--surface2);
            border: 1px solid var(--border);
            border-radius: 5px;
            cursor: pointer;
            color: var(--ink2);
            transition: all 0.1s;
        }

        .print-bc-btn:hover { background: var(--accent); color: #fff; border-color: var(--accent); }

        /* Print modal */
        .print-modal {
            position: fixed;
            inset: 0;
            background: rgba(10,12,20,0.7);
            backdrop-filter: blur(4px);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .print-box {
            background: #fff;
            border-radius: 16px;
            padding: 28px;
            width: 320px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .print-box h4 {
            font-size: 15px;
            font-weight: 700;
            margin-bottom: 6px;
            color: var(--ink);
        }

        .print-box .pname-label {
            font-size: 13px;
            color: var(--ink2);
            margin-bottom: 16px;
        }

        #print-svg-wrap svg {
            width: 240px;
            height: 80px;
        }

        .print-actions {
            display: flex;
            gap: 10px;
            margin-top: 18px;
        }

        .print-actions button {
            flex: 1;
            padding: 10px;
            border-radius: 8px;
            font-family: 'DM Sans', sans-serif;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            border: none;
        }

        .btn-print { background: var(--accent); color: #fff; }
        .btn-print:hover { background: var(--accent2); }
        .btn-close-print { background: var(--bg); color: var(--ink2); }
        .btn-close-print:hover { background: var(--border); }

        /* =========== BARCODE SCANNER MODAL =========== */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(10,12,20,0.7);
            backdrop-filter: blur(4px);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-box {
            background: var(--surface);
            border-radius: 16px;
            width: 90%;
            max-width: 440px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .modal-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-header h4 { font-size: 15px; font-weight: 700; }

        .modal-close {
            width: 30px;
            height: 30px;
            border-radius: 8px;
            border: 1.5px solid var(--border);
            background: var(--bg);
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--ink2);
        }

        #scanner-container {
            position: relative;
            width: 100%;
            aspect-ratio: 4/3;
            background: #000;
            overflow: hidden;
        }

        #scanner-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .scanner-line {
            position: absolute;
            left: 10%;
            right: 10%;
            height: 2px;
            background: #4c6ef5;
            box-shadow: 0 0 12px #4c6ef5;
            animation: scan 2s ease-in-out infinite;
        }

        @keyframes scan {
            0%, 100% { top: 20%; }
            50% { top: 80%; }
        }

        .scanner-frame {
            position: absolute;
            inset: 10%;
            border: 2px solid rgba(255,255,255,0.5);
            border-radius: 8px;
        }

        .scanner-corner {
            position: absolute;
            width: 20px;
            height: 20px;
            border-color: #4c6ef5;
            border-style: solid;
        }
        .scanner-corner.tl { top: 10%; left: 10%; border-width: 3px 0 0 3px; border-radius: 4px 0 0 0; }
        .scanner-corner.tr { top: 10%; right: 10%; border-width: 3px 3px 0 0; border-radius: 0 4px 0 0; }
        .scanner-corner.bl { bottom: 10%; left: 10%; border-width: 0 0 3px 3px; border-radius: 0 0 0 4px; }
        .scanner-corner.br { bottom: 10%; right: 10%; border-width: 0 3px 3px 0; border-radius: 0 0 4px 0; }

        .scanner-result {
            padding: 14px 20px;
            font-family: 'DM Mono', monospace;
            font-size: 13px;
            color: var(--ink2);
            border-top: 1px solid var(--border);
            min-height: 48px;
        }

        .scanner-result.found { color: var(--green); font-weight: 600; }
        .scanner-result.notfound { color: var(--red); }

        .hidden { display: none !important; }

        /* Notif toast */
        .toast {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%) translateY(80px);
            background: #0f1117;
            color: #fff;
            padding: 12px 20px;
            border-radius: 10px;
            font-size: 13px;
            font-weight: 500;
            z-index: 9999;
            transition: transform 0.3s ease;
            white-space: nowrap;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .toast.show { transform: translateX(-50%) translateY(0); }
        .toast.success { background: var(--green); }
        .toast.error { background: var(--red); }

        /* Image Upload */
        .img-upload-box {
            border: 2px dashed var(--border);
            border-radius: 10px;
            padding: 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.15s;
            background: var(--bg);
            position: relative;
        }
        .img-upload-box:hover { border-color: var(--amber); background: #fffbf0; }
        .img-upload-box input[type=file] { display: none; }
        .img-preview {
            width: 80px; height: 80px;
            object-fit: cover;
            border-radius: 8px;
            margin: 0 auto 8px;
            display: block;
            border: 1.5px solid var(--border);
        }
        .img-upload-label { font-size: 12px; color: var(--ink3); }
        .img-upload-label span { color: var(--amber); font-weight: 600; cursor: pointer; }

        /* Stock table image */
        .td-img { width: 48px; }
        .prod-thumb {
            width: 44px; height: 44px;
            object-fit: cover;
            border-radius: 8px;
            border: 1.5px solid var(--border);
            background: var(--bg);
        }
        .prod-thumb-placeholder {
            width: 44px; height: 44px;
            border-radius: 8px;
            border: 1.5px dashed var(--border);
            background: var(--bg);
            display: flex; align-items: center; justify-content: center;
            font-size: 18px; color: var(--ink3);
        }

        /* Barcode cell */
        .barcode-cell { cursor: pointer; }
        .barcode-cell svg { display: block; }
        .barcode-cell:hover svg { opacity: 0.75; }
        .bc-none { font-size: 11px; color: var(--ink3); font-family: 'DM Mono', monospace; }

        /* Product card image */
        .product-card .pimg {
            width: 100%; height: 70px;
            object-fit: cover;
            border-radius: 6px;
            margin-bottom: 8px;
            background: var(--bg);
        }
        .product-card .pimg-ph {
            width: 100%; height: 50px;
            display: flex; align-items: center; justify-content: center;
            font-size: 24px; margin-bottom: 8px;
            background: var(--surface2);
            border-radius: 6px;
        }

        /* Print barcode modal content */
        .print-box {
            padding: 20px;
            text-align: center;
        }
        .print-box .pname-big { font-size: 15px; font-weight: 700; margin-bottom: 4px; color: var(--ink); }
        .print-box .pprice-label { font-size: 13px; color: var(--ink2); margin-bottom: 16px; }
        #print-svg-wrap svg { max-width: 100%; height: 80px; }
        .print-actions { display: flex; gap: 10px; margin-top: 18px; }
        .print-actions button { flex: 1; padding: 10px; border-radius: 8px; font-family: 'DM Sans', sans-serif; font-size: 13px; font-weight: 600; cursor: pointer; border: none; }
        .btn-print { background: var(--accent); color: #fff; }
        .btn-print:hover { background: var(--accent2); }
        .btn-close-print { background: var(--bg); color: var(--ink2); }
        .btn-close-print:hover { background: var(--border); }

        @media (max-width: 600px) {
            .panel-right { width: 100%; }
            .app-layout { flex-direction: column; }
            .gudang-layout { flex-direction: column; }
            .gudang-left { width: 100%; max-height: 50vh; }
        }

        /* =========== KASIR FULLSCREEN =========== */
        .kasir-fullscreen {
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: var(--bg);
            max-width: 480px;
            margin: 0 auto;
        }

        .kasir-topbar {
            background: var(--ink);
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-shrink: 0;
        }

        .kasir-search-bar {
            background: var(--surface);
            padding: 12px 14px;
            display: flex;
            gap: 10px;
            align-items: center;
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
        }

        .kasir-pelanggan-bar {
            background: var(--surface);
            padding: 10px 14px;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
        }

        /* Search dropdown */
        .search-dropdown {
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            max-height: 220px;
            overflow-y: auto;
            flex-shrink: 0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            z-index: 10;
        }
        .search-dropdown::-webkit-scrollbar { width: 4px; }
        .search-dropdown::-webkit-scrollbar-thumb { background: #d0d5e8; }

        .sdrop-item {
            padding: 11px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: background 0.1s;
        }
        .sdrop-item:last-child { border-bottom: none; }
        .sdrop-item:hover { background: var(--surface2); }
        .sdrop-item.disabled { opacity: 0.4; pointer-events: none; }
        .sdrop-name { font-size: 14px; font-weight: 600; color: var(--ink); }
        .sdrop-price { font-family: 'DM Mono', monospace; font-size: 12px; color: var(--accent); }
        .sdrop-stock { font-size: 11px; padding: 2px 8px; border-radius: 5px; }

        /* Cart scroll fills remaining space */
        .kasir-cart-scroll {
            flex: 1;
            overflow-y: auto;
            padding: 8px 14px;
        }
        .kasir-cart-scroll::-webkit-scrollbar { width: 4px; }
        .kasir-cart-scroll::-webkit-scrollbar-thumb { background: #d0d5e8; border-radius: 2px; }

        .pay-method-btn {
            padding: 7px 4px; border-radius: 8px; font-size: 11px; font-weight: 600;
            border: 1.5px solid var(--border); background: var(--bg); color: var(--ink2);
            cursor: pointer; font-family: 'DM Sans', sans-serif; transition: all 0.15s;
        }
        .pay-method-btn.active { border-color: var(--accent); background: #eef2ff; color: var(--accent); }
        .pay-method-btn:hover { border-color: var(--accent); color: var(--accent); }

        /* Footer always at bottom */
        .kasir-footer {
            background: var(--surface);
            border-top: 1px solid var(--border);
            padding: 14px 16px;
            flex-shrink: 0;
            box-shadow: 0 -4px 16px rgba(0,0,0,0.06);
        }

        .footer-summary {
            background: var(--surface2);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 12px 14px;
        }
    </style>
</head>
<body>

<!-- ROLE SCREEN -->
<div id="role-screen">
    <p class="role-logo">POS SYSTEM</p>
    <h1 class="role-title">Pilih Mode</h1>
    <p class="role-subtitle">Masuk sebagai Kasir atau petugas Gudang</p>
    <div class="role-cards">
        <div class="role-card" id="btn-kasir">
            <div class="icon">üì≤</div>
            <div class="label">KASIR</div>
            <div class="desc">Transaksi & Pembayaran</div>
        </div>
        <div class="role-card" id="btn-gudang">
            <div class="icon">üì¶</div>
            <div class="label">GUDANG</div>
            <div class="desc">Kelola Produk & Stok</div>
        </div>
    </div>
    <div class="conn-chip" id="conn-status">‚è≥ Menghubungkan ke database...</div>
</div>

<!-- KASIR SCREEN -->
<div id="kasir-screen" class="hidden">
    <div class="kasir-fullscreen">

        <!-- Header -->
        <div class="kasir-topbar">
            <span class="topbar-title" style="font-size:15px; font-weight:700; color:#fff;">üè™ POS Kasir</span>
            <a href="pelanggan.html" style="padding:6px 12px; background:rgba(255,255,255,0.12); color:#fff; border-radius:8px; font-size:12px; font-weight:700; text-decoration:none; border:1px solid rgba(255,255,255,0.2);">üë•</a>
            <button class="exit-btn" onclick="resetRole()" style="background:rgba(255,255,255,0.12); color:#fff; border:1px solid rgba(255,255,255,0.2);">Keluar</button>
        </div>

        <!-- Search + Scan -->
        <div class="kasir-search-bar">
            <div class="search-wrap" style="flex:1;">
                <span class="icon-search">üîç</span>
                <input type="text" class="search-input" id="search-kasir" placeholder="Ketik nama produk lalu Enter..." oninput="filterProducts()" onkeydown="onSearchEnter(event)" style="background:#fff;">
            </div>
            <button class="barcode-btn" onclick="openScanner('kasir')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:18px;height:18px;">
                    <path d="M3 7V5a2 2 0 012-2h2M17 3h2a2 2 0 012 2v2M21 17v2a2 2 0 01-2 2h-2M7 21H5a2 2 0 01-2-2v-2"/>
                    <line x1="7" y1="8" x2="7" y2="16"/><line x1="10" y1="8" x2="10" y2="16"/>
                    <line x1="13" y1="8" x2="13" y2="16"/><line x1="16" y1="8" x2="16" y2="16"/>
                </svg>
                Scan
            </button>
        </div>

        <!-- Dropdown hasil pencarian -->
        <div id="search-dropdown" class="search-dropdown hidden"></div>

        <!-- Pelanggan -->
        <div class="kasir-pelanggan-bar">
            <span style="font-size:12px; font-weight:700; color:var(--ink2); white-space:nowrap;">Pelanggan:</span>
            <select id="kasir-pelanggan" onchange="onPelangganChange()" style="flex:1; padding:8px 10px; border:1.5px solid var(--border); border-radius:9px; font-family:'DM Sans',sans-serif; font-size:13px; color:var(--ink); background:var(--bg); outline:none;">
                <option value="">‚Äî Umum ‚Äî</option>
            </select>
            <div id="pelanggan-info-tag" style="font-size:11px; color:var(--ink3); white-space:nowrap;"></div>
        </div>

        <!-- Cart Items (scrollable) -->
        <div class="kasir-cart-scroll" id="cart-list">
            <div class="cart-empty">
                <div class="empty-icon">üõí</div>
                <span>Scan barcode atau cari produk</span>
            </div>
        </div>

        <!-- Footer selalu di bawah -->
        <div class="kasir-footer">
            <div class="footer-summary">
                <div style="display:flex; justify-content:space-between; font-size:13px; color:var(--ink3); margin-bottom:8px;">
                    <span>Item: <b id="cart-count" style="color:var(--ink);">0</b></span>
                    <span id="subtotal-price" style="display:none;"></span>
                </div>
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                    <span style="font-size:13px; color:var(--ink2);">Total Bayar</span>
                    <span style="font-family:'DM Mono',monospace; font-size:22px; font-weight:800; color:var(--ink);" id="total-price">Rp 0</span>
                </div>
                <!-- Metode Bayar -->
                <div style="display:grid; grid-template-columns:repeat(4,1fr); gap:6px; margin-bottom:10px;" id="pay-method-btns">
                    <button class="pay-method-btn active" data-m="Tunai" onclick="selectPayMethod(this)">üíµ Tunai</button>
                    <button class="pay-method-btn" data-m="Transfer" onclick="selectPayMethod(this)">üè¶ Transfer</button>
                    <button class="pay-method-btn" data-m="QRIS" onclick="selectPayMethod(this)">üì± QRIS</button>
                    <button class="pay-method-btn" data-m="Kartu" onclick="selectPayMethod(this)">üí≥ Kartu</button>
                </div>
                <!-- Uang Bayar (hanya untuk Tunai) -->
                <div id="uang-bayar-wrap" style="margin-bottom:10px;">
                    <div style="font-size:11px; color:var(--ink3); font-weight:600; margin-bottom:4px;">UANG BAYAR</div>
                    <input type="text" inputmode="numeric" id="uang-bayar" placeholder="0" oninput="formatUangBayar(this)"
                        style="width:100%; padding:9px 12px; border:1.5px solid var(--border); border-radius:9px;
                        font-family:'DM Mono',monospace; font-size:16px; font-weight:700; color:var(--ink);
                        background:var(--bg); outline:none; text-align:right;">
                    <div style="display:flex; justify-content:space-between; margin-top:6px; font-size:13px;">
                        <span style="color:var(--ink3);">Kembalian</span>
                        <span id="kembalian-val" style="font-family:'DM Mono',monospace; font-weight:700; color:var(--green);">Rp 0</span>
                    </div>
                </div>
            </div>
            <button class="pay-btn" onclick="processPayment()" style="border-radius:14px; font-size:16px; padding:16px; margin-top:12px;">
                BAYAR & CETAK STRUK ‚Üí
            </button>
        </div>

    </div>
</div>

<!-- GUDANG SCREEN -->
<div id="gudang-screen" class="hidden">
    <div class="gudang-layout">
        <!-- Kiri: Form -->
        <div class="gudang-left">
            <div class="panel-topbar">
                <span class="topbar-title">Gudang Pro</span>
                <span class="topbar-tag tag-gudang">GUDANG</span>
                <a href="rekap.html" style="padding:7px 14px; background:#fff3bf; color:#b07d00; border-radius:8px; font-size:13px; font-weight:700; text-decoration:none; border:1px solid #ffe066;">üìä Rekap</a>
                <button class="exit-btn" onclick="resetRole()">Keluar</button>
            </div>
            <div class="form-scroll">
                <div class="section-header" style="padding:0; border:none; margin-bottom:16px;">
                    <h4>Tambah Produk Baru</h4>
                    <small>Isi form untuk menambah ke database</small>
                </div>
                <div class="form-group">
                    <label>Nama Produk</label>
                    <input type="text" id="new-name" placeholder="Contoh: Kopi Arabika 250g">
                </div>
                <div class="form-group">
                    <label>Harga Jual Eceran (Rp)</label>
                    <input type="number" id="new-price" placeholder="15000">
                </div>
                <div class="form-group" style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
                    <div>
                        <label style="display:block; font-size:11px; font-weight:700; color:var(--ink2); margin-bottom:5px; text-transform:uppercase; letter-spacing:0.5px;">Harga Grosir (Rp)</label>
                        <input type="number" id="new-harga-grosir" placeholder="12000" style="margin:0;">
                    </div>
                    <div>
                        <label style="display:block; font-size:11px; font-weight:700; color:var(--ink2); margin-bottom:5px; text-transform:uppercase; letter-spacing:0.5px;">Min. Qty Grosir</label>
                        <input type="number" id="new-min-grosir" placeholder="12" style="margin:0;">
                    </div>
                </div>
                <div class="form-group">
                    <label>Stok Awal</label>
                    <input type="number" id="new-stock" placeholder="50">
                </div>
                <div class="form-group">
                    <label>Barcode (Opsional)</label>
                    <div style="display:flex; gap:8px;">
                        <input type="text" id="new-barcode" placeholder="Scan atau ketik kode" style="flex:1;">
                        <button onclick="openScanner('gudang-input')" style="padding:10px 12px; background:var(--accent); color:#fff; border:none; border-radius:8px; cursor:pointer; font-size:16px;" title="Scan Barcode">üì∑</button>
                    </div>
                </div>
                <div class="form-group">
                    <label>Foto Produk (Opsional)</label>
                    <div class="img-upload-box" onclick="document.getElementById('new-image').click()">
                        <input type="file" id="new-image" accept="image/*" onchange="previewImage(event)">
                        <img id="img-preview-thumb" class="img-preview" style="display:none;">
                        <div id="img-upload-placeholder">
                            <div style="font-size:28px; margin-bottom:6px;">üñº</div>
                            <div class="img-upload-label"><span>Klik untuk pilih foto</span> atau drag & drop</div>
                        </div>
                    </div>
                </div>
                <button class="add-product-btn" onclick="addProduct()">+ Tambah ke Database</button>
            </div>
        </div>

        <!-- Kanan: Daftar Stok -->
        <div class="gudang-right">
            <div class="panel-topbar">
                <span class="topbar-title">Daftar Stok</span>
                <div class="search-wrap" style="width:220px;">
                    <span class="icon-search">üîç</span>
                    <input type="text" class="search-input" id="search-gudang" placeholder="Cari produk..." oninput="renderStockGudang()">
                </div>
                <button class="barcode-btn" onclick="openScanner('gudang-cek')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px">
                        <path d="M3 7V5a2 2 0 012-2h2M17 3h2a2 2 0 012 2v2M21 17v2a2 2 0 01-2 2h-2M7 21H5a2 2 0 01-2-2v-2"/>
                        <line x1="7" y1="8" x2="7" y2="16"/><line x1="10" y1="8" x2="10" y2="16"/>
                        <line x1="13" y1="8" x2="13" y2="16"/><line x1="16" y1="8" x2="16" y2="16"/>
                    </svg>
                    Cek Stok
                </button>
            </div>
            <div class="stock-scroll">
                <table class="stock-table">
                    <thead>
                        <tr>
                            <th class="td-img"></th>
                            <th>Produk</th>
                            <th>Harga</th>
                            <th>Barcode</th>
                            <th>Stok</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="stock-list"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- EDIT PRODUCT MODAL -->
<div id="edit-modal" class="modal-overlay hidden">
    <div class="modal-box">
        <div class="modal-header">
            <h4>‚úèÔ∏è Edit Produk</h4>
            <button class="modal-close" onclick="closeEditModal()">‚úï</button>
        </div>
        <div style="padding:20px; overflow-y:auto; max-height:70vh;">
            <input type="hidden" id="edit-id">
            <div class="form-group">
                <label>Nama Produk</label>
                <input type="text" id="edit-name" placeholder="Nama produk">
            </div>
            <div class="form-group">
                <label>Harga Jual Eceran (Rp)</label>
                <input type="number" id="edit-price" placeholder="Harga">
            </div>
            <div class="form-group" style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
                <div>
                    <label style="display:block; font-size:11px; font-weight:700; color:var(--ink2); margin-bottom:5px; text-transform:uppercase; letter-spacing:0.5px;">Harga Grosir (Rp)</label>
                    <input type="number" id="edit-harga-grosir" placeholder="0" style="margin:0;">
                </div>
                <div>
                    <label style="display:block; font-size:11px; font-weight:700; color:var(--ink2); margin-bottom:5px; text-transform:uppercase; letter-spacing:0.5px;">Min. Qty Grosir</label>
                    <input type="number" id="edit-min-grosir" placeholder="0" style="margin:0;">
                </div>
            </div>
            <div class="form-group">
                <label>Stok</label>
                <input type="number" id="edit-stock" placeholder="Stok">
            </div>
            <div class="form-group">
                <label>Barcode</label>
                <div style="display:flex; gap:8px;">
                    <input type="text" id="edit-barcode" placeholder="Barcode" style="flex:1;">
                    <button onclick="openScanner('edit-barcode')" style="padding:10px 12px; background:var(--accent); color:#fff; border:none; border-radius:8px; cursor:pointer; font-size:16px;">üì∑</button>
                </div>
            </div>
            <div class="form-group">
                <label>Foto Produk</label>
                <div class="img-upload-box" onclick="document.getElementById('edit-image').click()">
                    <input type="file" id="edit-image" accept="image/*" onchange="previewEditImage(event)">
                    <img id="edit-img-thumb" class="img-preview" style="display:none;">
                    <div id="edit-img-placeholder">
                        <div style="font-size:28px; margin-bottom:6px;">üñº</div>
                        <div class="img-upload-label"><span>Klik untuk ganti foto</span></div>
                    </div>
                </div>
            </div>
            <div style="display:flex; gap:10px; margin-top:6px;">
                <button onclick="closeEditModal()" style="flex:1; padding:11px; border-radius:8px; border:1.5px solid var(--border); background:var(--bg); font-family:DM Sans,sans-serif; font-size:13px; font-weight:600; cursor:pointer; color:var(--ink2);">Batal</button>
                <button onclick="saveEdit()" style="flex:2; padding:11px; border-radius:8px; border:none; background:var(--accent); color:#fff; font-family:DM Sans,sans-serif; font-size:13px; font-weight:700; cursor:pointer;">Simpan Perubahan</button>
            </div>
        </div>
    </div>
</div>

<!-- PRINT BARCODE MODAL -->
<div id="print-modal" class="modal-overlay hidden">
    <div class="modal-box">
        <div class="modal-header">
            <h4>üñ® Cetak Label Barcode</h4>
            <button class="modal-close" onclick="document.getElementById('print-modal').classList.add('hidden')">‚úï</button>
        </div>
        <div class="print-box">
            <div class="pname-big" id="print-pname"></div>
            <div class="pprice-label" id="print-pprice"></div>
            <div id="print-svg-wrap"><svg id="print-barcode-svg"></svg></div>
            <div class="print-actions">
                <button class="btn-close-print" onclick="document.getElementById('print-modal').classList.add('hidden')">Tutup</button>
                <button class="btn-print" onclick="printBarcode()">üñ® Print</button>
            </div>
        </div>
    </div>
</div>

<!-- SCANNER MODAL -->
<div id="scanner-modal" class="modal-overlay hidden">
    <div class="modal-box">
        <div class="modal-header">
            <h4>üì∑ Scan Barcode</h4>
            <button class="modal-close" onclick="closeScanner()">‚úï</button>
        </div>
        <div id="scanner-container">
            <video id="scanner-video" autoplay playsinline muted></video>
            <div class="scanner-line"></div>
            <div class="scanner-corner tl"></div>
            <div class="scanner-corner tr"></div>
            <div class="scanner-corner bl"></div>
            <div class="scanner-corner br"></div>
        </div>
        <div class="scanner-result" id="scanner-result">Arahkan kamera ke barcode produk...</div>
    </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<!-- ZXing Barcode Library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/zxing-js/0.19.1/zxing.min.js"></script>
<!-- JsBarcode untuk generate gambar barcode -->
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>

<!-- Konfigurasi Firebase (file terpisah) -->
<script src="config.js"></script>

<script>
// ========== FIREBASE ==========

try {
    firebase.initializeApp(firebaseConfig);
    var db = firebase.database();
    var productsRef = db.ref('products');
    var pelangganRef = db.ref('pelanggan');
    var transaksiRef = db.ref('transaksi');
    document.getElementById('conn-status').innerHTML = "‚úÖ Database Terhubung";
    document.getElementById('btn-kasir').onclick = function() { setRole('kasir'); };
    document.getElementById('btn-gudang').onclick = function() { checkAdminPassword(); };
} catch (e) {
    document.getElementById('conn-status').innerHTML = "‚ùå Gagal: " + e.message;
}

// ========== STATE ==========
var productsData = {};
var pelangganData = {};
var cart = [];
var scannerMode = '';
var codeReader = null;
var scannerStream = null;
var activePelangganId = '';
var activePelangganTipe = 'umum';
var activePayMethod = 'Tunai';

// ========== TOAST ==========
function showToast(msg, type) {
    var t = document.getElementById('toast');
    t.textContent = msg;
    t.className = 'toast ' + (type || '');
    t.classList.add('show');
    setTimeout(function() { t.classList.remove('show'); }, 2500);
}

// ========== LOGIN SEDERHANA ==========
var ADMIN_PASSWORD = "admin123"; // Ganti password ini sesuai keinginan

function checkAdminPassword() {
    var pass = prompt("Masukkan Password Gudang:");
    if (pass === ADMIN_PASSWORD) {
        setRole('gudang');
    } else if (pass !== null) {
        alert("Password salah!");
    }
}

// ========== NAVIGATION ==========
function setRole(role) {
    localStorage.setItem('appRole', role);
    document.getElementById('role-screen').classList.add('hidden');
    if (role === 'kasir') {
        document.getElementById('kasir-screen').classList.remove('hidden');
        loadPelangganDropdown();
    } else {
        document.getElementById('gudang-screen').classList.remove('hidden');
        renderStockGudang();
    }
}

function resetRole() {
    localStorage.removeItem('appRole');
    location.reload();
}

var currentRole = localStorage.getItem('appRole');
if (currentRole) setRole(currentRole);

// ========== PELANGGAN ==========
function loadPelangganDropdown() {
    var sel = document.getElementById('kasir-pelanggan');
    if (!sel) return;
    var current = sel.value;
    sel.innerHTML = '<option value="">‚Äî Umum (Tanpa Member) ‚Äî</option>';
    var sorted = Object.keys(pelangganData).sort(function(a,b) {
        return (pelangganData[a].nama||'').localeCompare(pelangganData[b].nama||'');
    });
    sorted.forEach(function(id) {
        var p = pelangganData[id];
        var icon = p.tipe === 'grosir' ? 'üì¶' : p.tipe === 'member' ? '‚≠ê' : 'üë§';
        var opt = document.createElement('option');
        opt.value = id;
        opt.textContent = icon + ' ' + p.nama + ' (' + (p.tipe || 'umum') + ')';
        if (p.telepon) opt.textContent += ' ¬∑ ' + p.telepon;
        sel.appendChild(opt);
    });
    sel.value = current;
    onPelangganChange();
}

function onPelangganChange() {
    var sel = document.getElementById('kasir-pelanggan');
    activePelangganId = sel ? sel.value : '';
    var p = activePelangganId ? pelangganData[activePelangganId] : null;
    activePelangganTipe = p ? (p.tipe || 'umum') : 'umum';
    var info = document.getElementById('pelanggan-info-tag');
    if (info) {
        if (p) {
            var colors = { member: '#0ca678', umum: '#228be6' };
            var icons  = { member: '‚≠ê Harga Member', umum: 'üë§ Harga Eceran' };
            info.innerHTML = '<span style="color:' + (colors[p.tipe||'umum']||'#228be6') + '; font-weight:600;">' + (icons[p.tipe||'umum']||'üë§ Harga Eceran') + '</span>';
        } else {
            info.textContent = '';
        }
    }
    renderCart();
}

// ========== SPLIT PRICE ENGINE ==========
function calcSplitPrice(productId, qty) {
    var p = productsData[productId];
    if (!p) return { total: 0, grosirQty: 0, normalQty: qty, grosirPrice: 0, normalPrice: 0, hasSplit: false };

    var hasGrosir = p.harga_grosir && p.min_grosir && p.min_grosir > 0;

    if (!hasGrosir || qty < p.min_grosir) {
        return {
            total:      p.price * qty,
            grosirQty:  0,
            normalQty:  qty,
            grosirPrice: p.harga_grosir || 0,
            normalPrice: p.price,
            hasSplit:   false,
            nearGrosir: hasGrosir && qty < p.min_grosir,
            sisaQty:    hasGrosir ? p.min_grosir - qty : 0
        };
    }

    var batchCount = Math.floor(qty / p.min_grosir);
    var grosirQty  = batchCount * p.min_grosir;
    var normalQty  = qty - grosirQty;

    return {
        total:        (grosirQty * p.harga_grosir) + (normalQty * p.price),
        grosirQty:    grosirQty,
        normalQty:    normalQty,
        grosirPrice:  p.harga_grosir,
        normalPrice:  p.price,
        hasSplit:     normalQty > 0,
        isFullGrosir: normalQty === 0,
        nearGrosir:   false,
        sisaQty:      0
    };
}

// ========== KASIR ==========
function filterProducts() {
    var q = (document.getElementById('search-kasir').value || '').trim().toLowerCase();
    var dropdown = document.getElementById('search-dropdown');
    if (!q) { dropdown.classList.add('hidden'); dropdown.innerHTML = ''; return; }

    var keys = Object.keys(productsData);
    var filtered = keys.filter(function(id) {
        var p = productsData[id];
        return p.name.toLowerCase().includes(q) || (p.barcode && p.barcode.toLowerCase().includes(q));
    }).slice(0, 8);

    if (filtered.length === 0) {
        dropdown.classList.remove('hidden');
        dropdown.innerHTML = '<div style="padding:14px 16px; font-size:13px; color:var(--ink3); text-align:center;">Produk tidak ditemukan</div>';
        return;
    }

    dropdown.classList.remove('hidden');
    dropdown.innerHTML = '';
    filtered.forEach(function(id) {
        var p = productsData[id];
        var isOut = p.stock <= 0;
        var stockColor = isOut ? 'var(--red)' : p.stock <= 5 ? 'var(--amber)' : 'var(--green)';
        var stockBg   = isOut ? '#ffe3e3' : p.stock <= 5 ? '#fff3bf' : '#e6fcf5';
        var div = document.createElement('div');
        div.className = 'sdrop-item' + (isOut ? ' disabled' : '');
        div.innerHTML =
            '<div><div class="sdrop-name">' + p.name + '</div>' +
            '<div class="sdrop-price">Rp ' + p.price.toLocaleString('id-ID') + (p.harga_grosir ? ' ¬∑ Grosir Rp ' + p.harga_grosir.toLocaleString('id-ID') : '') + '</div></div>' +
            '<span class="sdrop-stock" style="background:' + stockBg + '; color:' + stockColor + '; font-weight:700;">' + (isOut ? 'Habis' : 'Stok ' + p.stock) + '</span>';
        if (!isOut) div.onclick = function() { addToCart(id); clearSearch(); };
        dropdown.appendChild(div);
    });
}

function onSearchEnter(e) {
    if (e.key !== 'Enter') return;
    var q = (document.getElementById('search-kasir').value || '').trim().toLowerCase();
    if (!q) return;
    var keys = Object.keys(productsData);
    var match = keys.find(function(id) {
        var p = productsData[id];
        return (p.barcode && p.barcode.toLowerCase() === q) || p.name.toLowerCase() === q;
    });
    if (match && productsData[match].stock > 0) { addToCart(match); clearSearch(); }
}

function clearSearch() {
    document.getElementById('search-kasir').value = '';
    var dd = document.getElementById('search-dropdown');
    dd.classList.add('hidden');
    dd.innerHTML = '';
}

function renderProductKasir() { /* not used ‚Äî products shown via search dropdown */ }

function addToCart(id) {
    var p = productsData[id];
    if (!p || p.stock <= 0) return;
    var found = false;
    for (var i = 0; i < cart.length; i++) {
        if (cart[i].id === id) {
            if (cart[i].qty < p.stock) { cart[i].qty++; }
            else { showToast('Stok tidak mencukupi!', 'error'); }
            found = true;
            break;
        }
    }
    if (!found) cart.push({ id: id, name: p.name, qty: 1, basePrice: p.price, harga_grosir: p.harga_grosir || 0, min_grosir: p.min_grosir || 0 });
    renderCart();
}

function changeQty(index, delta) {
    cart[index].qty += delta;
    if (cart[index].qty <= 0) { cart.splice(index, 1); }
    renderCart();
}

function renderCart() {
    var container = document.getElementById('cart-list');
    container.innerHTML = '';
    var total = 0;

    if (cart.length === 0) {
        container.innerHTML = '<div class="cart-empty"><div class="empty-icon">üõí</div><span>Scan barcode atau cari produk</span></div>';
        document.getElementById('cart-count').textContent = '0';
        document.getElementById('total-price').textContent = 'Rp 0';
        document.getElementById('subtotal-price').textContent = 'Rp 0';
        return;
    }

    var totalItems = 0;
    cart.forEach(function(item, i) {
        var sp = calcSplitPrice(item.id, item.qty);
        total += sp.total;
        totalItems += item.qty;

        if (sp.hasSplit) {
            var p = productsData[item.id];
            var batchCount = p && p.min_grosir ? Math.floor(item.qty / p.min_grosir) : 1;
            var batchLabel = batchCount > 1
                ? batchCount + ' √ó ' + p.min_grosir + ' = ' + sp.grosirQty
                : sp.grosirQty;
            var subtotalGrosir = sp.grosirQty * sp.grosirPrice;
            var rowGrosir = document.createElement('div');
            rowGrosir.className = 'cart-row';
            rowGrosir.innerHTML =
                '<div class="info">' +
                  '<div class="cname">' + item.name +
                    ' <span style="font-size:10px;background:#fff4e6;color:#f76707;padding:1px 6px;border-radius:4px;font-weight:700;margin-left:4px;">GROSIR</span>' +
                  '</div>' +
                  '<div style="font-size:11px;color:var(--ink3);margin-top:2px;">@Rp ' + sp.grosirPrice.toLocaleString('id-ID') + ' <s style="color:#ccc;">Rp ' + sp.normalPrice.toLocaleString('id-ID') + '</s></div>' +
                '</div>' +
                '<div class="cright">' +
                  '<div class="cprice">Rp ' + subtotalGrosir.toLocaleString('id-ID') + '</div>' +
                  '<div class="qty-ctrl">' +
                    '<button class="qty-btn minus" onclick="changeQty(' + i + ', -1)" style="opacity:0.35;pointer-events:none;">‚àí</button>' +
                    '<span class="qty-num">' + batchLabel + '</span>' +
                    '<button class="qty-btn" onclick="changeQty(' + i + ', 1)" style="opacity:0.35;pointer-events:none;">+</button>' +
                  '</div>' +
                '</div>';
            container.appendChild(rowGrosir);

            var subtotalNormal = sp.normalQty * sp.normalPrice;
            var rowNormal = document.createElement('div');
            rowNormal.className = 'cart-row';
            rowNormal.innerHTML =
                '<div class="info">' +
                  '<div class="cname">' + item.name +
                    ' <span style="font-size:10px;background:#f1f3f5;color:#555;padding:1px 6px;border-radius:4px;font-weight:600;margin-left:4px;">NORMAL</span>' +
                  '</div>' +
                  '<div style="font-size:11px;color:var(--ink3);margin-top:2px;">@Rp ' + sp.normalPrice.toLocaleString('id-ID') + '</div>' +
                '</div>' +
                '<div class="cright">' +
                  '<div class="cprice">Rp ' + subtotalNormal.toLocaleString('id-ID') + '</div>' +
                  '<div class="qty-ctrl">' +
                    '<button class="qty-btn minus" onclick="changeQty(' + i + ', -1)">‚àí</button>' +
                    '<span class="qty-num">' + sp.normalQty + '</span>' +
                    '<button class="qty-btn" onclick="changeQty(' + i + ', 1)">+</button>' +
                  '</div>' +
                '</div>';
            container.appendChild(rowNormal);

        } else if (sp.grosirQty > 0 && sp.normalQty === 0) {
            var rowFull = document.createElement('div');
            rowFull.className = 'cart-row';
            rowFull.innerHTML =
                '<div class="info">' +
                  '<div class="cname">' + item.name +
                    ' <span style="font-size:10px;background:#fff4e6;color:#f76707;padding:1px 6px;border-radius:4px;font-weight:700;margin-left:4px;">GROSIR</span>' +
                  '</div>' +
                  '<div style="font-size:11px;color:var(--ink3);margin-top:2px;">@Rp ' + sp.grosirPrice.toLocaleString('id-ID') + ' <s style="color:#ccc;">Rp ' + sp.normalPrice.toLocaleString('id-ID') + '</s></div>' +
                '</div>' +
                '<div class="cright">' +
                  '<div class="cprice">Rp ' + sp.total.toLocaleString('id-ID') + '</div>' +
                  '<div class="qty-ctrl">' +
                    '<button class="qty-btn minus" onclick="changeQty(' + i + ', -1)">‚àí</button>' +
                    '<span class="qty-num">' + item.qty + '</span>' +
                    '<button class="qty-btn" onclick="changeQty(' + i + ', 1)">+</button>' +
                  '</div>' +
                '</div>';
            container.appendChild(rowFull);

        } else {
            var nearGrosir = sp.nearGrosir;
            var badge = nearGrosir
                ? ' <span style="font-size:10px;background:#f1f3f5;color:#8891a5;padding:1px 6px;border-radius:4px;font-weight:600;margin-left:4px;">+' + sp.sisaQty + ' ‚Üí grosir</span>'
                : '';
            var rowNorm = document.createElement('div');
            rowNorm.className = 'cart-row';
            rowNorm.innerHTML =
                '<div class="info">' +
                  '<div class="cname">' + item.name + badge + '</div>' +
                  '<div style="font-size:11px;color:var(--ink3);margin-top:2px;">@Rp ' + sp.normalPrice.toLocaleString('id-ID') + '</div>' +
                '</div>' +
                '<div class="cright">' +
                  '<div class="cprice">Rp ' + sp.total.toLocaleString('id-ID') + '</div>' +
                  '<div class="qty-ctrl">' +
                    '<button class="qty-btn minus" onclick="changeQty(' + i + ', -1)">‚àí</button>' +
                    '<span class="qty-num">' + item.qty + '</span>' +
                    '<button class="qty-btn" onclick="changeQty(' + i + ', 1)">+</button>' +
                  '</div>' +
                '</div>';
            container.appendChild(rowNorm);
        }
    });

    document.getElementById('cart-count').textContent = totalItems;
    document.getElementById('total-price').textContent = 'Rp ' + total.toLocaleString('id-ID');
    document.getElementById('subtotal-price').textContent = 'Rp ' + total.toLocaleString('id-ID');
}

function selectPayMethod(btn) {
    document.querySelectorAll('.pay-method-btn').forEach(function(b) { b.classList.remove('active'); });
    btn.classList.add('active');
    activePayMethod = btn.dataset.m;
    var wrap = document.getElementById('uang-bayar-wrap');
    if (wrap) wrap.style.display = activePayMethod === 'Tunai' ? 'block' : 'none';
    if (activePayMethod !== 'Tunai') {
        document.getElementById('kembalian-val').textContent = 'Rp 0';
    }
}

function formatUangBayar(input) {
    var raw = input.value.replace(/\./g, '').replace(/[^0-9]/g, '');
    if (raw === '') { input.value = ''; hitungKembalian(); return; }
    var num = parseInt(raw, 10);
    input.value = num.toLocaleString('id-ID');
    hitungKembalian();
}

function hitungKembalian() {
    var totalEl = document.getElementById('total-price');
    var total = parseInt((totalEl.textContent || '0').replace(/[^0-9]/g, '')) || 0;
    var rawBayar = (document.getElementById('uang-bayar').value || '').replace(/\./g, '').replace(/[^0-9]/g, '');
    var bayar = parseInt(rawBayar) || 0;
    var kembalian = bayar - total;
    var el = document.getElementById('kembalian-val');
    if (kembalian < 0) {
        el.textContent = '‚àí Rp ' + Math.abs(kembalian).toLocaleString('id-ID');
        el.style.color = 'var(--red)';
    } else {
        el.textContent = 'Rp ' + kembalian.toLocaleString('id-ID');
        el.style.color = 'var(--green)';
    }
}

// ========== TRANSAKSI AMAN (TRANSACTION) ==========
async function processPayment() {
    if (cart.length === 0) return showToast('Keranjang kosong!', 'error');

    var rawBayar = activePayMethod === 'Tunai' ? ((document.getElementById('uang-bayar').value || '').replace(/\./g, '').replace(/[^0-9]/g, '')) : '0';
    var uangBayar = activePayMethod === 'Tunai' ? (parseInt(rawBayar) || 0) : 0;
    var updates = {};
    var total = 0;
    var totalQty = 0;
    var totalHemat = 0;
    var items = [];

    // Cek stok awal
    for (var i = 0; i < cart.length; i++) {
        var item = cart[i];
        if (!productsData[item.id] || productsData[item.id].stock < item.qty) {
            return showToast('Stok ' + item.name + ' tidak cukup!', 'error');
        }
    }

    // Kalkulasi
    for (var i = 0; i < cart.length; i++) {
        var item = cart[i];
        var sp = calcSplitPrice(item.id, item.qty);
        total += sp.total;
        totalQty += item.qty;
        totalHemat += (sp.normalPrice * item.qty) - sp.total;
        items.push({
            product_id:   item.id,
            name:         item.name,
            barcode:      productsData[item.id] ? (productsData[item.id].barcode || '') : '',
            qty:          item.qty,
            subtotal:     sp.total,
            grosir_qty:   sp.grosirQty,
            normal_qty:   sp.normalQty,
            harga_grosir: sp.grosirPrice,
            harga_normal: sp.normalPrice
        });
    }

    if (activePayMethod === 'Tunai' && uangBayar < total) {
        return showToast('Uang bayar kurang!', 'error');
    }

    var now = Date.now();
    var d = new Date(now);
    var kembalian = activePayMethod === 'Tunai' ? uangBayar - total : 0;

    var trx = {
        items: items, total: total, timestamp: now,
        tahun: d.getFullYear(), bulan: d.getMonth() + 1,
        tipe_harga: activePelangganTipe || 'umum',
        metode_bayar: activePayMethod,
        uang_bayar: uangBayar, kembalian: kembalian
    };
    if (activePelangganId) {
        trx.pelanggan_id   = activePelangganId;
        trx.pelanggan_nama = pelangganData[activePelangganId] ? pelangganData[activePelangganId].nama : '';
    }

    try {
        // 1. Transaction Stock (Atomic)
        for (var i = 0; i < cart.length; i++) {
            var item = cart[i];
            await productsRef.child(item.id + '/stock').transaction(function(currentStock) {
                if (currentStock === null) return 0;
                if (currentStock < item.qty) return; // Abort
                return currentStock - item.qty;
            });
        }

        // 2. Push Transaksi
        var ref = await transaksiRef.push(trx);
        var trxId = ref.key;
        showToast('‚úÖ Pembayaran berhasil!', 'success');
        cetakStruk(trxId, items, total, totalQty, totalHemat, kembalian, uangBayar, d);
        
        cart = [];
        renderCart();
        document.getElementById('uang-bayar').value = '';
        document.getElementById('kembalian-val').textContent = 'Rp 0';
    } catch (e) {
        showToast('Gagal: ' + e.message, 'error');
    }
}

// ========== CETAK STRUK DETAIL (RESTORED) ==========
function cetakStruk(trxId, items, total, totalQty, totalHemat, kembalian, uangBayar, d) {
    var pad = function(n) { return n.toString().padStart(2, '0'); };
    var tglStr = pad(d.getDate()) + '-' + pad(d.getMonth()+1) + '-' + d.getFullYear() +
                 '-' + pad(d.getHours()) + ':' + pad(d.getMinutes()) + ':' + pad(d.getSeconds());
    var noStruk = trxId ? trxId.slice(-8).toUpperCase() : '00000000';
    var pelNama = activePelangganId && pelangganData[activePelangganId] ? pelangganData[activePelangganId].nama : '';

    function struKItemRow(no, nama, barcode, qty, harga, subtotal) {
        var hargaFmt    = harga.toLocaleString('id-ID');
        var subtotalFmt = subtotal.toLocaleString('id-ID');
        return (
            '<tr>' +
              '<td colspan="3" style="padding:2px 0 0;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.2px;">' +
                no + '. ' + nama +
              '</td>' +
            '</tr>' +
            '<tr>' +
              '<td style="padding:0 0 4px;font-size:12px;color:#444;">' +
                qty + ' X ' + hargaFmt +
              '</td>' +
              '<td style="font-size:12px;text-align:center;color:#444;font-weight:700;">=</td>' +
              '<td style="font-size:12px;text-align:right;font-weight:700;white-space:nowrap;">Rp ' + subtotalFmt + '</td>' +
            '</tr>'
        );
    }

    var itemRows = '';
    var lineNo = 0;
    items.forEach(function(item) {
        if (item.grosir_qty > 0 && item.normal_qty > 0) {
            lineNo++;
            itemRows += struKItemRow(lineNo, item.name + '[GROSIR]', item.barcode, item.grosir_qty, item.harga_grosir, item.grosir_qty * item.harga_grosir);
            lineNo++;
            itemRows += struKItemRow(lineNo, item.name, '', item.normal_qty, item.harga_normal, item.normal_qty * item.harga_normal);
        } else {
            lineNo++;
            var harga = item.grosir_qty > 0 ? item.harga_grosir : item.harga_normal;
            var label = item.name + (item.grosir_qty > 0 ? '[GROSIR]' : '');
            itemRows += struKItemRow(lineNo, label, item.barcode, item.qty, harga, item.subtotal);
        }
    });

    var metodeBayarRows = '';
    if (activePayMethod === 'Tunai') {
        metodeBayarRows =
            '<tr><td style="padding:1px 0;font-size:12px;font-weight:700;">TUNAI</td>' +
            '<td style="font-size:12px;text-align:center;font-weight:700;">=</td>' +
            '<td style="font-size:12px;text-align:right;font-weight:700;">Rp ' + uangBayar.toLocaleString('id-ID') + '</td></tr>' +
            '<tr><td style="padding:1px 0;font-size:12px;font-weight:700;">KEMBALI</td>' +
            '<td style="font-size:12px;text-align:center;font-weight:900;">=</td>' +
            '<td style="font-size:12px;text-align:right;font-weight:900;">Rp ' + kembalian.toLocaleString('id-ID') + '</td></tr>';
    } else {
        metodeBayarRows =
            '<tr><td style="padding:1px 0;font-size:12px;font-weight:700;">NET ' + activePayMethod.toUpperCase() + '</td>' +
            '<td style="font-size:12px;text-align:center;font-weight:800;">=</td>' +
            '<td style="font-size:12px;text-align:right;font-weight:800;">Rp ' + total.toLocaleString('id-ID') + '</td></tr>' +
            '<tr><td style="padding:1px 0;font-size:12px;font-weight:700;">NAMA CARD</td>' +
            '<td></td><td style="font-size:12px;text-align:right;">' + activePayMethod.toUpperCase() + '</td></tr>' +
            '<tr><td style="padding:1px 0;font-size:12px;font-weight:700;">KEMBALI</td>' +
            '<td style="font-size:12px;text-align:center;">=</td>' +
            '<td style="font-size:12px;text-align:right;">Rp 0</td></tr>';
    }

    var hematRow = totalHemat > 0
        ? '<tr><td style="padding:2px 0 0;font-size:12px;font-weight:700;">ANDA HEMAT</td>' +
          '<td style="font-size:12px;text-align:center;font-weight:900;">=</td>' +
          '<td style="font-size:12px;text-align:right;font-weight:900;">Rp ' + totalHemat.toLocaleString('id-ID') + '</td></tr>'
        : '';

    var pelLine = pelNama ? '<div style="font-size:11px;margin:2px 0;">Pelanggan: <b>' + pelNama + '</b></div>' : '';

    var win = window.open('', '_blank', 'width=380,height=650,scrollbars=yes');
    win.document.write(
'<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Struk #' + noStruk + '</title>' +
'<style>' +
'*{margin:0;padding:0;box-sizing:border-box;}' +
'body{font-family:"Courier New",Courier,monospace;width:280px;margin:0 auto;padding:14px 6px;font-size:12px;color:#000;background:#fff;}' +
'.toko-nama{text-align:center;font-size:15px;font-weight:900;letter-spacing:1px;margin-bottom:2px;}' +
'.toko-sub{text-align:center;font-size:10px;color:#555;margin-bottom:6px;}' +
'hr.dash{border:none;border-top:1px dashed #000;margin:5px 0;}' +
'hr.dash2{border:none;margin:5px 0;height:4px;background:none;border-top:1px dashed #000;border-bottom:1px dashed #000;}' +
'hr.dot{border:none;border-top:1px dotted #000;margin:5px 0;}' +
'table{width:100%;border-collapse:collapse;}' +
'.footer-center{text-align:center;font-size:14px;font-weight:900;letter-spacing:3px;margin:8px 0 3px;}' +
'.trx-id{text-align:center;font-size:10px;color:#555;}' +
'@media print{body{width:280px;padding:4px;}@page{margin:0;size:80mm auto;}}' +
'</style></head><body>' +
'<div class="toko-nama">TOKO ANDA</div>' +
'<div class="toko-sub">Kudus, Jawa Tengah</div>' +
pelLine +
'<hr class="dash2">' +
'<table>' +
'<colgroup><col style="width:auto"><col style="width:40px"><col style="width:80px"></colgroup>' +
itemRows +

'<tr><td colspan="3" style="padding:2px 0;"><hr style="border:none;border-top:1px dashed #000;margin:0;"></td></tr>' +
'<tr><td style="padding:1px 0;font-size:12px;font-weight:700;">TOTAL QTY</td>' +
'<td style="font-size:12px;text-align:center;">=</td>' +
'<td style="font-size:12px;text-align:right;font-weight:700;"><b>' + totalQty + '</b></td></tr>' +
'<tr><td style="padding:1px 0;font-size:12px;font-weight:900;">TOTAL</td>' +
'<td style="font-size:12px;text-align:center;font-weight:900;">=</td>' +
'<td style="font-size:12px;text-align:right;font-weight:900;">Rp ' + total.toLocaleString('id-ID') + '</td></tr>' +
metodeBayarRows +
hematRow +
'</table>' +
'<hr class="dot">' +
'<div class="footer-center">TERIMA KASIH</div>' +
'<div class="trx-id">' + tglStr + '/' + noStruk + '</div>' +
'</body></html>'
    );
    win.document.close();
    win.focus();
    setTimeout(function() { win.print(); }, 500);
}



// ========== GUDANG ==========
var newImageData = null;

function previewImage(event) {
    var file = event.target.files[0];
    if (!file) return;
    var reader = new FileReader();
    reader.onload = function(e) {
        // Resize via canvas
        var img = new Image();
        img.onload = function() {
            var canvas = document.createElement('canvas');
            var max = 300;
            var w = img.width, h = img.height;
            if (w > h) { if (w > max) { h = h * max / w; w = max; } }
            else { if (h > max) { w = w * max / h; h = max; } }
            canvas.width = w; canvas.height = h;
            canvas.getContext('2d').drawImage(img, 0, 0, w, h);
            newImageData = canvas.toDataURL('image/jpeg', 0.7);
            var thumb = document.getElementById('img-preview-thumb');
            thumb.src = newImageData;
            thumb.style.display = 'block';
            document.getElementById('img-upload-placeholder').style.display = 'none';
        };
        img.src = e.target.result;
    };
    reader.readAsDataURL(file);
}

function addProduct() {
    var name = document.getElementById('new-name').value.trim();
    var price = parseInt(document.getElementById('new-price').value);
    var stock = parseInt(document.getElementById('new-stock').value);
    var barcode = document.getElementById('new-barcode').value.trim();
    var harga_grosir = parseInt(document.getElementById('new-harga-grosir').value) || 0;
    var min_grosir = parseInt(document.getElementById('new-min-grosir').value) || 0;
    if (!name || isNaN(price) || isNaN(stock)) { showToast('Lengkapi semua data!', 'error'); return; }
    var data = { name: name, price: price, stock: stock };
    if (barcode) data.barcode = barcode;
    if (harga_grosir > 0) data.harga_grosir = harga_grosir;
    if (min_grosir > 0) data.min_grosir = min_grosir;
    if (newImageData) data.image = newImageData;
    productsRef.push(data).then(function() {
        showToast('‚úÖ Produk berhasil ditambahkan!', 'success');
        document.getElementById('new-name').value = '';
        document.getElementById('new-price').value = '';
        document.getElementById('new-stock').value = '';
        document.getElementById('new-barcode').value = '';
        document.getElementById('new-harga-grosir').value = '';
        document.getElementById('new-min-grosir').value = '';
        document.getElementById('new-image').value = '';
        document.getElementById('img-preview-thumb').style.display = 'none';
        document.getElementById('img-upload-placeholder').style.display = 'block';
        newImageData = null;
    }).catch(function(e) { showToast('Gagal: ' + e.message, 'error'); });
}

function updateStock(id, newStock) {
    if (newStock < 0) newStock = 0;
    var updates = {};
    updates['/products/' + id + '/stock'] = newStock;
    db.ref().update(updates);
}

function deleteProduct(id) {
    if (!confirm('Hapus produk ini?')) return;
    productsRef.child(id).remove().then(function() {
        showToast('Produk dihapus', '');
    });
}

function renderStockGudang() {
    var q = (document.getElementById('search-gudang').value || '').toLowerCase();
    var tbody = document.getElementById('stock-list');
    tbody.innerHTML = '';
    var keys = Object.keys(productsData);
    var filtered = keys.filter(function(id) {
        var p = productsData[id];
        return p.name.toLowerCase().includes(q) || (p.barcode && p.barcode.toLowerCase().includes(q));
    });

    if (filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; color:var(--ink3); padding:30px; font-size:13px;">Produk tidak ditemukan</td></tr>';
        return;
    }

    filtered.forEach(function(id) {
        var p = productsData[id];
        var tr = document.createElement('tr');

        // Foto
        var imgHtml = p.image
            ? '<img src="' + p.image + '" class="prod-thumb" alt="' + p.name + '">'
            : '<div class="prod-thumb-placeholder">üì¶</div>';

        // Barcode batang
        var bcHtml;
        if (p.barcode) {
            var svgId = 'bc-' + id;
            bcHtml = '<div class="barcode-cell" onclick="openPrintModal(\'' + id + '\')" title="Klik untuk cetak"><svg id="' + svgId + '"></svg></div>';
        } else {
            bcHtml = '<span class="bc-none">‚Äî</span>';
        }

        tr.innerHTML =
            '<td class="td-img">' + imgHtml + '</td>' +
            '<td class="td-name">' + p.name + (p.harga_grosir ? '<br><span style="font-size:10px; color:var(--amber); font-family:DM Mono,monospace; font-weight:600;">Grosir: Rp ' + p.harga_grosir.toLocaleString('id-ID') + ' (min.' + (p.min_grosir||0) + ')</span>' : '') + '</td>' +
            '<td class="td-price">Rp ' + p.price.toLocaleString('id-ID') + '</td>' +
            '<td>' + bcHtml + '</td>' +
            '<td><div class="td-stock-ctrl">' +
            '<button class="sctrl-btn minus" onclick="updateStock(\'' + id + '\', ' + (p.stock - 1) + ')">‚àí</button>' +
            '<span class="stock-num">' + p.stock + '</span>' +
            '<button class="sctrl-btn plus" onclick="updateStock(\'' + id + '\', ' + (p.stock + 1) + ')">+</button>' +
            '</div></td>' +
            '<td><div class="action-btns"><button class="edit-btn" onclick="openEditModal(\'' + id + '\')">‚úè</button><button class="del-btn" onclick="deleteProduct(\'' + id + '\')">üóë</button></div></td>';
        tbody.appendChild(tr);

        // Render barcode SVG setelah element masuk DOM
        if (p.barcode) {
            try {
                JsBarcode('#bc-' + id, p.barcode, {
                    format: 'CODE128',
                    width: 1.5,
                    height: 40,
                    displayValue: true,
                    fontSize: 9,
                    margin: 4,
                    background: 'transparent'
                });
            } catch(e) { /* barcode tidak valid */ }
        }
    });
}

// ========== EDIT PRODUCT ==========
var editImageData = null;

function openEditModal(id) {
    var p = productsData[id];
    if (!p) return;
    document.getElementById('edit-id').value = id;
    document.getElementById('edit-name').value = p.name;
    document.getElementById('edit-price').value = p.price;
    document.getElementById('edit-harga-grosir').value = p.harga_grosir || '';
    document.getElementById('edit-min-grosir').value = p.min_grosir || '';
    document.getElementById('edit-stock').value = p.stock;
    document.getElementById('edit-barcode').value = p.barcode || '';
    editImageData = p.image || null;
    var thumb = document.getElementById('edit-img-thumb');
    if (p.image) {
        thumb.src = p.image;
        thumb.style.display = 'block';
        document.getElementById('edit-img-placeholder').style.display = 'none';
    } else {
        thumb.style.display = 'none';
        document.getElementById('edit-img-placeholder').style.display = 'block';
    }
    document.getElementById('edit-modal').classList.remove('hidden');
}

function closeEditModal() {
    document.getElementById('edit-modal').classList.add('hidden');
    editImageData = null;
}

function previewEditImage(event) {
    var file = event.target.files[0];
    if (!file) return;
    var reader = new FileReader();
    reader.onload = function(e) {
        var img = new Image();
        img.onload = function() {
            var canvas = document.createElement('canvas');
            var max = 300;
            var w = img.width, h = img.height;
            if (w > h) { if (w > max) { h = h * max / w; w = max; } }
            else { if (h > max) { w = w * max / h; h = max; } }
            canvas.width = w; canvas.height = h;
            canvas.getContext('2d').drawImage(img, 0, 0, w, h);
            editImageData = canvas.toDataURL('image/jpeg', 0.7);
            var thumb = document.getElementById('edit-img-thumb');
            thumb.src = editImageData;
            thumb.style.display = 'block';
            document.getElementById('edit-img-placeholder').style.display = 'none';
        };
        img.src = e.target.result;
    };
    reader.readAsDataURL(file);
}

function saveEdit() {
    var id = document.getElementById('edit-id').value;
    var name = document.getElementById('edit-name').value.trim();
    var price = parseInt(document.getElementById('edit-price').value);
    var stock = parseInt(document.getElementById('edit-stock').value);
    var barcode = document.getElementById('edit-barcode').value.trim();
    if (!name || isNaN(price) || isNaN(stock)) { showToast('Lengkapi semua data!', 'error'); return; }
    var data = { name: name, price: price, stock: stock };
    if (barcode) data.barcode = barcode; else data.barcode = null;
    var hg = parseInt(document.getElementById('edit-harga-grosir').value) || 0;
    var mg = parseInt(document.getElementById('edit-min-grosir').value) || 0;
    data.harga_grosir = hg > 0 ? hg : null;
    data.min_grosir = mg > 0 ? mg : null;
    if (editImageData) data.image = editImageData; else data.image = null;
    productsRef.child(id).update(data).then(function() {
        showToast('‚úÖ Produk diperbarui!', 'success');
        closeEditModal();
    }).catch(function(e) { showToast('Gagal: ' + e.message, 'error'); });
}

// ========== PRINT BARCODE ==========
function openPrintModal(id) {
    var p = productsData[id];
    if (!p || !p.barcode) return;
    document.getElementById('print-pname').textContent = p.name;
    document.getElementById('print-pprice').textContent = 'Rp ' + p.price.toLocaleString('id-ID');
    document.getElementById('print-modal').classList.remove('hidden');
    try {
        JsBarcode('#print-barcode-svg', p.barcode, {
            format: 'CODE128',
            width: 2.5,
            height: 80,
            displayValue: true,
            fontSize: 13,
            margin: 8
        });
    } catch(e) {}
}

function printBarcode() {
    var name = document.getElementById('print-pname').textContent;
    var price = document.getElementById('print-pprice').textContent;
    var svgEl = document.getElementById('print-barcode-svg');
    var svgData = new XMLSerializer().serializeToString(svgEl);
    var win = window.open('', '_blank');
    win.document.write('<html><head><title>Print Barcode</title><style>body{font-family:sans-serif;text-align:center;padding:30px} h2{margin:0 0 4px} p{margin:0 0 16px;color:#555}</style></head><body>');
    win.document.write('<h2>' + name + '</h2><p>' + price + '</p>');
    win.document.write(svgData);
    win.document.write('</body></html>');
    win.document.close();
    win.focus();
    setTimeout(function() { win.print(); win.close(); }, 300);
}

// ========== BARCODE SCANNER ==========
function openScanner(mode) {
    scannerMode = mode;
    document.getElementById('scanner-modal').classList.remove('hidden');
    document.getElementById('scanner-result').textContent = 'Arahkan kamera ke barcode produk...';
    document.getElementById('scanner-result').className = 'scanner-result';
    startCamera();
}

function closeScanner() {
    document.getElementById('scanner-modal').classList.add('hidden');
    stopCamera();
}

function startCamera() {
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        document.getElementById('scanner-result').textContent = '‚ùå Kamera tidak didukung di browser ini';
        return;
    }
    navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
        .then(function(stream) {
            scannerStream = stream;
            var video = document.getElementById('scanner-video');
            video.srcObject = stream;
            video.play();
            startBarcodeDetection(video);
        })
        .catch(function(e) {
            document.getElementById('scanner-result').textContent = '‚ùå Gagal akses kamera: ' + e.message;
        });
}

function stopCamera() {
    if (scannerStream) {
        scannerStream.getTracks().forEach(function(t) { t.stop(); });
        scannerStream = null;
    }
    if (codeReader) {
        try { codeReader.reset(); } catch(e) {}
        codeReader = null;
    }
}

function startBarcodeDetection(video) {
    if ('BarcodeDetector' in window) {
        var detector = new BarcodeDetector({ formats: ['ean_13', 'ean_8', 'qr_code', 'code_128', 'code_39', 'upc_a', 'upc_e'] });
        var scanning = true;

        function detect() {
            if (!scanning || !scannerStream) return;
            detector.detect(video).then(function(barcodes) {
                if (barcodes.length > 0) {
                    scanning = false;
                    handleBarcode(barcodes[0].rawValue);
                } else {
                    requestAnimationFrame(detect);
                }
            }).catch(function() {
                requestAnimationFrame(detect);
            });
        }

        video.onloadedmetadata = function() { detect(); };
        if (video.readyState >= 2) detect();

    } else if (typeof ZXing !== 'undefined') {
        try {
            codeReader = new ZXing.BrowserMultiFormatReader();
            codeReader.decodeFromVideoElement(video, function(result, err) {
                if (result) {
                    codeReader.reset();
                    handleBarcode(result.getText());
                }
            });
        } catch(e) {
            document.getElementById('scanner-result').textContent = '‚ö† Scanner tidak tersedia. Ketik barcode manual.';
        }
    } else {
        document.getElementById('scanner-result').textContent = '‚ö† Browser tidak mendukung scan otomatis. Gunakan Chrome/Edge terbaru.';
    }
}

function handleBarcode(code) {
    document.getElementById('scanner-result').textContent = '‚úÖ Terdeteksi: ' + code;
    document.getElementById('scanner-result').className = 'scanner-result found';

    if (scannerMode === 'gudang-input') {
        document.getElementById('new-barcode').value = code;
        closeScanner();
        showToast('Barcode: ' + code, 'success');
    } else if (scannerMode === 'edit-barcode') {
        document.getElementById('edit-barcode').value = code;
        closeScanner();
        showToast('Barcode: ' + code, 'success');
    } else if (scannerMode === 'gudang-cek') {
        var found = null;
        for (var id in productsData) {
            if (productsData[id].barcode === code) { found = productsData[id]; break; }
        }
        if (found) {
            document.getElementById('scanner-result').textContent = '‚úÖ ' + found.name + ' ‚Äî Stok: ' + found.stock;
            document.getElementById('search-gudang').value = found.name;
            renderStockGudang();
        } else {
            document.getElementById('scanner-result').textContent = '‚ö† Barcode tidak ditemukan di database';
            document.getElementById('scanner-result').className = 'scanner-result notfound';
        }
        setTimeout(closeScanner, 2000);
    } else if (scannerMode === 'kasir') {
        var foundId = null;
        for (var pid in productsData) {
            if (productsData[pid].barcode === code) { foundId = pid; break; }
        }
        if (foundId) {
            addToCart(foundId);
            document.getElementById('scanner-result').textContent = '‚úÖ ' + productsData[foundId].name + ' ditambahkan!';
            setTimeout(closeScanner, 1000);
        } else {
            document.getElementById('search-kasir').value = code;
            filterProducts();
            document.getElementById('scanner-result').textContent = 'üîç Mencari: ' + code;
            setTimeout(closeScanner, 1000);
        }
    }
}

// ========== REALTIME LISTENER ==========
productsRef.on('value', function(snapshot) {
    productsData = snapshot.val() || {};
    var role = localStorage.getItem('appRole');
    if (role === 'gudang') renderStockGudang();
});

pelangganRef.on('value', function(snapshot) {
    pelangganData = snapshot.val() || {};
    loadPelangganDropdown();
});
</script>
</body>
</html>